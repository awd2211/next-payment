# å…¨çƒæ”¯ä»˜å¹³å°å¼€å‘è®¡åˆ’ - å…¨çƒåŒ–æ–¹æ¡ˆ

> **æ–¹æ¡ˆåç§°**: æ–¹æ¡ˆ2 - å…¨çƒåŒ– (Globalization)
>
> **ç›®æ ‡**: è¦†ç›–å…¨çƒä¸»æµæ”¯ä»˜å¸‚åœºï¼Œæ”¯æŒä¸­å›½ã€æ¬§ç¾ã€ä¸œå—äºš
>
> **é€‰å®šæ¨¡å—**: A(å¯¹è´¦ç³»ç»Ÿ) + B(æ‹’ä»˜ç®¡ç†) + C(å•†æˆ·é¢åº¦) + D(PayPal) + E(æ”¯ä»˜å®/å¾®ä¿¡) + H(æ”¯ä»˜è¶…æ—¶) + M(ç¾å¤‡é«˜å¯ç”¨)
>
> **é¢„ä¼°å·¥ä½œé‡**: 17å‘¨ â†’ **å¹¶è¡Œå¼€å‘ 10-12å‘¨**
>
> **å»ºè®®å›¢é˜Ÿ**: 3åç«¯ + 1å‰ç«¯ + 1DevOps
>
> **ç”Ÿæˆæ—¶é—´**: 2025-10-25

---

## ğŸ“‹ ç›®å½•

1. [æ€»è§ˆ](#æ€»è§ˆ)
2. [å¼€å‘æ—¶é—´çº¿](#å¼€å‘æ—¶é—´çº¿)
3. [æ¨¡å—è¯¦ç»†è®¾è®¡](#æ¨¡å—è¯¦ç»†è®¾è®¡)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
6. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)
7. [æµ‹è¯•è®¡åˆ’](#æµ‹è¯•è®¡åˆ’)
8. [é£é™©ä¸åº”å¯¹](#é£é™©ä¸åº”å¯¹)

---

## ğŸ“Š æ€»è§ˆ

### æ ¸å¿ƒç›®æ ‡

- âœ… **è´¢åŠ¡å®‰å…¨**: é€šè¿‡å¯¹è´¦ç³»ç»Ÿç¡®ä¿èµ„é‡‘å‡†ç¡®æ€§
- âœ… **é£é™©æ§åˆ¶**: æ‹’ä»˜ç®¡ç† + å•†æˆ·é¢åº¦ç®¡ç†é™ä½æŸå¤±
- âœ… **å…¨çƒè¦†ç›–**: Stripe + PayPal + æ”¯ä»˜å® + å¾®ä¿¡æ”¯ä»˜è¦†ç›–90%+å…¨çƒå¸‚åœº
- âœ… **è¿è¥æ•ˆç‡**: è‡ªåŠ¨åŒ–è¶…æ—¶å¤„ç†é‡Šæ”¾äººåŠ›
- âœ… **é«˜å¯ç”¨æ€§**: ç¾å¤‡ç³»ç»Ÿä¿éšœ99.99%å¯ç”¨æ€§

### è¦†ç›–å¸‚åœº

| åœ°åŒº | æ¸ é“ | å¸‚åœºè¦†ç›–ç‡ |
|------|------|-----------|
| ğŸ‡¨ğŸ‡³ ä¸­å›½ | æ”¯ä»˜å® + å¾®ä¿¡æ”¯ä»˜ | 90%+ |
| ğŸ‡ºğŸ‡¸ åŒ—ç¾ | Stripe + PayPal | 85%+ |
| ğŸ‡ªğŸ‡º æ¬§æ´² | Stripe + PayPal | 80%+ |
| ğŸŒ ä¸œå—äºš | Stripe + æ”¯ä»˜å® | 70%+ |
| ğŸŒ å…¶ä»– | Stripe + PayPal | 60%+ |

### å…³é”®æŒ‡æ ‡æå‡

| æŒ‡æ ‡ | ç°çŠ¶ | ç›®æ ‡ | æå‡ |
|------|------|------|------|
| å¸‚åœºè¦†ç›– | ä»…Stripe (30%) | 90%+ | +60% |
| æ‹’ä»˜æŸå¤±ç‡ | ä¸å¯æ§ | <0.5% | -70% |
| å¯¹è´¦å‡†ç¡®æ€§ | äººå·¥å¯¹è´¦ | 99.9% | è‡ªåŠ¨åŒ– |
| è®¢å•ç§¯å‹ | é•¿æœŸpending | 0 | 100% |
| ç³»ç»Ÿå¯ç”¨æ€§ | å•ç‚¹æ•…éšœ | 99.99% | é«˜å¯ç”¨ |

---

## ğŸ—“ï¸ å¼€å‘æ—¶é—´çº¿

### æ€»è§ˆ (12å‘¨ = 3ä¸ªæœˆ)

```
Week 1-2   : Sprint 1 - åŸºç¡€è®¾æ–½ + æ¡†æ¶æ­å»º
Week 3-5   : Sprint 2 - æ ¸å¿ƒåŠŸèƒ½å¼€å‘ (å¯¹è´¦ + æ‹’ä»˜ + é¢åº¦)
Week 6-8   : Sprint 3 - æ¸ é“é›†æˆ (PayPal + æ”¯ä»˜å®/å¾®ä¿¡)
Week 9-10  : Sprint 4 - è¶…æ—¶å¤„ç† + ç¾å¤‡éƒ¨ç½²
Week 11    : Sprint 5 - é›†æˆæµ‹è¯• + å‹åŠ›æµ‹è¯•
Week 12    : Sprint 6 - ä¸Šçº¿å‡†å¤‡ + ç°åº¦å‘å¸ƒ
```

### è¯¦ç»†ç”˜ç‰¹å›¾

#### **Sprint 1: Week 1-2 (åŸºç¡€è®¾æ–½)**

| ä»»åŠ¡ | è´Ÿè´£äºº | å¤©æ•° | ä¾èµ– |
|------|--------|------|------|
| æ•°æ®åº“Schemaè®¾è®¡ | åç«¯1 | 2 | - |
| APIæ¥å£è®¾è®¡è¯„å®¡ | å›¢é˜Ÿ | 1 | Schema |
| PostgreSQLä¸»ä»æ­å»º | DevOps | 3 | - |
| Redis Clusteræ­å»º | DevOps | 2 | - |
| Kafkaå¤šå‰¯æœ¬é…ç½® | DevOps | 2 | - |
| CI/CD Pipeline | DevOps | 2 | - |
| ç›‘æ§Dashboard | DevOps | 1 | - |

**äº¤ä»˜ç‰©**:
- âœ… å®Œæ•´çš„æ•°æ®åº“Schema
- âœ… APIæ¥å£æ–‡æ¡£ v1.0
- âœ… é«˜å¯ç”¨åŸºç¡€è®¾æ–½
- âœ… CI/CDè‡ªåŠ¨åŒ–æµç¨‹

---

#### **Sprint 2: Week 3-5 (æ ¸å¿ƒåŠŸèƒ½)**

**æ¨¡å—A: å¯¹è´¦ç³»ç»Ÿ** (åç«¯1, 5å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| Reconciliation Serviceå®ç° | 2 | æ ¸å¿ƒå¯¹è´¦é€»è¾‘ |
| æ¸ é“è´¦å•ä¸‹è½½å™¨ (Stripe) | 1 | å®šæ—¶ä¸‹è½½Stripeè´¦å• |
| å·®å¼‚æ£€æµ‹ç®—æ³• | 1 | ä¸‰æ–¹å¯¹è´¦ + å·®å¼‚æ ‡è®° |
| å¯¹è´¦æŠ¥è¡¨ç”Ÿæˆ | 1 | PDFæŠ¥è¡¨ + é‚®ä»¶é€šçŸ¥ |

**æ¨¡å—B: æ‹’ä»˜ç®¡ç†** (åç«¯2, 4å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| Dispute Model + Repository | 1 | æ•°æ®æ¨¡å‹ |
| Webhookæ¥æ”¶å™¨ | 1 | stripe.dispute.* äº‹ä»¶ |
| è¯æ®ä¸Šä¼ API | 1 | å•†æˆ·ä¸Šä¼ è¯æ® |
| è‡ªåŠ¨æäº¤åˆ°Stripe | 1 | è°ƒç”¨Dispute Evidence API |

**æ¨¡å—C: å•†æˆ·é¢åº¦ç®¡ç†** (åç«¯3, 5å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| å•†æˆ·åˆ†çº§ç³»ç»Ÿ | 1 | Tieré…ç½®è¡¨ + å‡é™çº§é€»è¾‘ |
| é¢åº¦è®¡ç®—æœåŠ¡ | 1 | å®æ—¶é¢åº¦æ£€æŸ¥ |
| Redisè®¡æ•°å™¨ | 1 | æ—¥/æœˆç´¯è®¡ç»Ÿè®¡ |
| è¶…é™æ‹¦æˆªä¸­é—´ä»¶ | 1 | æ”¯ä»˜å‰æ£€æŸ¥ |
| é¢åº¦ç»Ÿè®¡Dashboard | 1 | Adminåå°é¡µé¢ |

**å‰ç«¯å¼€å‘** (å‰ç«¯, 5å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| å¯¹è´¦æŠ¥è¡¨é¡µé¢ | 2 | å¯¹è´¦å·®å¼‚åˆ—è¡¨ + è¯¦æƒ… |
| æ‹’ä»˜ç®¡ç†é¡µé¢ | 2 | æ‹’ä»˜å·¥å• + è¯æ®ä¸Šä¼  |
| å•†æˆ·é¢åº¦é¡µé¢ | 1 | é¢åº¦ä½¿ç”¨æƒ…å†µ + è°ƒæ•´ |

**äº¤ä»˜ç‰©**:
- âœ… å¯¹è´¦ç³»ç»Ÿæ¯æ—¥è‡ªåŠ¨è¿è¡Œ
- âœ… æ‹’ä»˜è‡ªåŠ¨æ£€æµ‹ + é€šçŸ¥
- âœ… å•†æˆ·é¢åº¦å®æ—¶æ‹¦æˆª

---

#### **Sprint 3: Week 6-8 (æ¸ é“é›†æˆ)**

**æ¨¡å—D: PayPalé›†æˆ** (åç«¯1, 8å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| PayPal Adapterå®ç° | 2 | å®ç°PaymentAdapteræ¥å£ |
| Checkouté›†æˆ | 2 | Orders API v2 |
| é€€æ¬¾é›†æˆ | 1 | Captures API |
| WebhookéªŒè¯ | 1 | PAYPAL-TRANSMISSION-SIG |
| å¯¹è´¦æ–‡ä»¶ä¸‹è½½ | 1 | Settlement Report API |
| å•å…ƒæµ‹è¯• | 1 | Mockæµ‹è¯• |

**æ¨¡å—E: æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜** (åç«¯2+3, 10å¤©)

| ä»»åŠ¡ | è´Ÿè´£äºº | å¤©æ•° | è¯´æ˜ |
|------|--------|------|------|
| æ”¯ä»˜å®Adapter | åç«¯2 | 3 | APP/ç½‘é¡µ/æ‰«ç æ”¯ä»˜ |
| æ”¯ä»˜å®é€€æ¬¾ | åç«¯2 | 1 | é€€æ¬¾API |
| æ”¯ä»˜å®å¯¹è´¦ | åç«¯2 | 1 | è´¦å•ä¸‹è½½ |
| å¾®ä¿¡Adapter | åç«¯3 | 3 | APP/ç½‘é¡µ/å°ç¨‹åº |
| å¾®ä¿¡é€€æ¬¾ | åç«¯3 | 1 | é€€æ¬¾API |
| å¾®ä¿¡å¯¹è´¦ | åç«¯3 | 1 | è´¦å•ä¸‹è½½ |

**å‰ç«¯å¼€å‘** (å‰ç«¯, 5å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| PayPalæ”¯ä»˜é¡µé¢ | 2 | Checkouté›†æˆ |
| æ”¯ä»˜å®æ”¯ä»˜é¡µé¢ | 2 | äºŒç»´ç å±•ç¤º + è·³è½¬ |
| å¾®ä¿¡æ”¯ä»˜é¡µé¢ | 1 | å°ç¨‹åº/H5è·³è½¬ |

**äº¤ä»˜ç‰©**:
- âœ… PayPalå…¨æµç¨‹ (æ”¯ä»˜+é€€æ¬¾+å¯¹è´¦)
- âœ… æ”¯ä»˜å®å…¨æµç¨‹
- âœ… å¾®ä¿¡æ”¯ä»˜å…¨æµç¨‹
- âœ… 4å¤§æ¸ é“å®Œæ•´è¦†ç›–

---

#### **Sprint 4: Week 9-10 (è¶…æ—¶å¤„ç† + ç¾å¤‡)**

**æ¨¡å—H: æ”¯ä»˜è¶…æ—¶å¤„ç†** (åç«¯1, 3å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| TimeoutServiceå®ç° | 1 | å®šæ—¶æ‰«ææœåŠ¡ |
| æ¸ é“å–æ¶ˆé›†æˆ | 1 | è°ƒç”¨å„æ¸ é“Cancel API |
| è¶…æ—¶é€šçŸ¥ | 1 | é‚®ä»¶/Webhooké€šçŸ¥ |

**æ¨¡å—M: ç¾å¤‡é«˜å¯ç”¨** (DevOps, 7å¤©)

| ä»»åŠ¡ | å¤©æ•° | è¯´æ˜ |
|------|------|------|
| PostgreSQL Failoveræµ‹è¯• | 2 | ä¸»ä»åˆ‡æ¢æ¼”ç»ƒ |
| Redis Sentinelé…ç½® | 1 | å“¨å…µæ¨¡å¼ |
| Kafkaå‰¯æœ¬éªŒè¯ | 1 | å‰¯æœ¬åŒæ­¥æµ‹è¯• |
| æœåŠ¡å¤šå®ä¾‹éƒ¨ç½² | 2 | Kubernetes HPA |
| å¤‡ä»½æ¢å¤æ¼”ç»ƒ | 1 | æ•°æ®æ¢å¤æµ‹è¯• |

**äº¤ä»˜ç‰©**:
- âœ… è¶…æ—¶è®¢å•è‡ªåŠ¨æ¸…ç†
- âœ… é«˜å¯ç”¨æ¶æ„éƒ¨ç½²å®Œæˆ
- âœ… 99.99%å¯ç”¨æ€§è¾¾æˆ

---

#### **Sprint 5: Week 11 (æµ‹è¯•)**

| æµ‹è¯•ç±»å‹ | è´Ÿè´£äºº | å¤©æ•° | è¦†ç›–èŒƒå›´ |
|---------|--------|------|----------|
| å•å…ƒæµ‹è¯• | åç«¯å›¢é˜Ÿ | 2 | æ‰€æœ‰æ–°å¢Service |
| é›†æˆæµ‹è¯• | åç«¯å›¢é˜Ÿ | 2 | ç«¯åˆ°ç«¯æµç¨‹ |
| å‹åŠ›æµ‹è¯• | DevOps | 1 | 1000 TPSç›®æ ‡ |
| å¯¹è´¦éªŒè¯ | åç«¯1 | 1 | æ¨¡æ‹ŸçœŸå®å¯¹è´¦ |
| ç¾å¤‡æ¼”ç»ƒ | DevOps | 1 | ä¸»åº“æ•…éšœåˆ‡æ¢ |

**æµ‹è¯•ç”¨ä¾‹æ•°**: 200+ (è¯¦è§æµ‹è¯•è®¡åˆ’ç« èŠ‚)

---

#### **Sprint 6: Week 12 (ä¸Šçº¿)**

| ä»»åŠ¡ | è´Ÿè´£äºº | å¤©æ•° | è¯´æ˜ |
|------|--------|------|------|
| ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² | DevOps | 1 | Kuberneteséƒ¨ç½² |
| ç°åº¦å‘å¸ƒ (10%) | å›¢é˜Ÿ | 2 | é€‰å®šæµ‹è¯•å•†æˆ· |
| ç›‘æ§å‘Šè­¦é…ç½® | DevOps | 1 | Prometheus + PagerDuty |
| æ–‡æ¡£å®Œå–„ | å›¢é˜Ÿ | 1 | è¿ç»´æ‰‹å†Œ + APIæ–‡æ¡£ |
| å…¨é‡å‘å¸ƒ | å›¢é˜Ÿ | 1 | 100%æµé‡åˆ‡æ¢ |

**ä¸Šçº¿æ£€æŸ¥æ¸…å•**: 50é¡¹ (è¯¦è§éƒ¨ç½²ç« èŠ‚)

---

## ğŸ”§ æ¨¡å—è¯¦ç»†è®¾è®¡

### æ¨¡å—A: å¯¹è´¦ç³»ç»Ÿ

#### ä¸šåŠ¡æµç¨‹

```
æ¯æ—¥å‡Œæ™¨2:00è‡ªåŠ¨è§¦å‘:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä¸‹è½½æ¸ é“è´¦å•                                      â”‚
â”‚    - Stripe: /v1/balance_transactions               â”‚
â”‚    - PayPal: /v1/reporting/transactions             â”‚
â”‚    - æ”¯ä»˜å®: dataservice.bill.downloadurl.query      â”‚
â”‚    - å¾®ä¿¡: POST /pay/downloadbill                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. æŸ¥è¯¢å†…éƒ¨è´¦åŠ¡è®°å½•                                  â”‚
â”‚    SELECT * FROM payments WHERE paid_at::date = ?   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. ä¸‰æ–¹å¯¹è´¦åŒ¹é…                                      â”‚
â”‚    - æŒ‰ payment_no/channel_order_no åŒ¹é…            â”‚
â”‚    - æ¯”å¯¹é‡‘é¢ã€çŠ¶æ€ã€æ‰‹ç»­è´¹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. ç”Ÿæˆå¯¹è´¦å·®å¼‚                                      â”‚
â”‚    - missing: å†…éƒ¨æœ‰ï¼Œæ¸ é“æ—  (å¯èƒ½ä¸¢å•)             â”‚
â”‚    - duplicate: æ¸ é“æœ‰ï¼Œå†…éƒ¨æ—  (å¯èƒ½é‡å¤)            â”‚
â”‚    - amount_mismatch: é‡‘é¢ä¸ä¸€è‡´                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. ç”Ÿæˆå¯¹è´¦æŠ¥è¡¨                                      â”‚
â”‚    - PDFæŠ¥è¡¨é‚®ä»¶å‘é€è´¢åŠ¡å›¢é˜Ÿ                         â”‚
â”‚    - å·®å¼‚å·¥å•è‡ªåŠ¨åˆ›å»º                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç ç»“æ„

```go
// backend/services/accounting-service/internal/service/reconciliation_service.go

package service

import (
    "context"
    "time"
)

type ReconciliationService interface {
    // æ¯æ—¥å¯¹è´¦ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼‰
    DailyReconcile(ctx context.Context, date time.Time) (*ReconcileReport, error)

    // ä¸‹è½½æ¸ é“è´¦å•
    DownloadChannelStatements(ctx context.Context, channel string, date time.Time) ([]Transaction, error)

    // æŸ¥è¯¢å†…éƒ¨è´¦åŠ¡
    GetInternalTransactions(ctx context.Context, date time.Time) ([]Transaction, error)

    // ä¸‰æ–¹å¯¹è´¦åŒ¹é…
    Match(internal, channel []Transaction) (*MatchResult, error)

    // å¤„ç†å·®å¼‚
    HandleDiscrepancies(ctx context.Context, discrepancies []Discrepancy) error

    // ç”Ÿæˆå¯¹è´¦æŠ¥è¡¨
    GenerateReport(ctx context.Context, result *MatchResult) (*ReconcileReport, error)
}

// å¯¹è´¦ç»“æœ
type ReconcileReport struct {
    Date                time.Time
    TotalInternal       int64  // å†…éƒ¨æ€»ç¬”æ•°
    TotalChannel        int64  // æ¸ é“æ€»ç¬”æ•°
    Matched             int64  // åŒ¹é…æˆåŠŸ
    Missing             int64  // å†…éƒ¨æœ‰ï¼Œæ¸ é“æ— 
    Duplicate           int64  // æ¸ é“æœ‰ï¼Œå†…éƒ¨æ— 
    AmountMismatch      int64  // é‡‘é¢ä¸ä¸€è‡´
    TotalDiscrepancies  int64  // æ€»å·®å¼‚æ•°
    MatchRate           float64 // åŒ¹é…ç‡ (%)
    Discrepancies       []Discrepancy
}

// å·®å¼‚ç±»å‹
type Discrepancy struct {
    ID              uuid.UUID
    Type            string  // "missing", "duplicate", "amount_mismatch"
    InternalOrderNo string
    ChannelOrderNo  string
    InternalAmount  int64
    ChannelAmount   int64
    AmountDiff      int64
    Status          string  // "pending", "resolved", "written_off"
    Resolution      string  // å¤„ç†è¯´æ˜
    ResolvedAt      *time.Time
}
```

#### æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- å¯¹è´¦è®°å½•è¡¨
CREATE TABLE reconciliation_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reconcile_date DATE NOT NULL,
    channel VARCHAR(50) NOT NULL,
    total_internal BIGINT NOT NULL,
    total_channel BIGINT NOT NULL,
    matched BIGINT NOT NULL,
    missing BIGINT NOT NULL,
    duplicate BIGINT NOT NULL,
    amount_mismatch BIGINT NOT NULL,
    match_rate DECIMAL(5,2) NOT NULL,
    status VARCHAR(20) NOT NULL, -- "pending", "completed", "reviewed"
    report_file_url TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMP,
    reviewed_by UUID,
    reviewed_at TIMESTAMP,
    INDEX idx_reconcile_date (reconcile_date),
    INDEX idx_status (status)
);

-- å¯¹è´¦å·®å¼‚è¡¨
CREATE TABLE reconciliation_discrepancies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    report_id UUID NOT NULL REFERENCES reconciliation_reports(id),
    type VARCHAR(20) NOT NULL, -- "missing", "duplicate", "amount_mismatch"
    internal_order_no VARCHAR(100),
    channel_order_no VARCHAR(100),
    internal_amount BIGINT,
    channel_amount BIGINT,
    amount_diff BIGINT,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    resolution TEXT,
    resolved_by UUID,
    resolved_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    INDEX idx_report_id (report_id),
    INDEX idx_status (status),
    INDEX idx_type (type)
);
```

---

### æ¨¡å—B: æ‹’ä»˜ç®¡ç†

#### ä¸šåŠ¡æµç¨‹

```
Stripe Webhook: dispute.created
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Webhookæ¥æ”¶                                       â”‚
â”‚    POST /webhooks/stripe                            â”‚
â”‚    éªŒè¯ç­¾å â†’ è§£æäº‹ä»¶                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. åˆ›å»ºæ‹’ä»˜è®°å½•                                      â”‚
â”‚    - æå–dispute_id, payment_intent, amount        â”‚
â”‚    - æŸ¥è¯¢å…³è”çš„Paymentè®°å½•                           â”‚
â”‚    - åˆ›å»ºDisputeè®°å½• (status=warning)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. é€šçŸ¥å•†æˆ·                                          â”‚
â”‚    - é‚®ä»¶é€šçŸ¥ (é™„è¯æ®è¦æ±‚)                           â”‚
â”‚    - Webhooké€šçŸ¥å•†æˆ·ç³»ç»Ÿ                             â”‚
â”‚    - Adminåå°åˆ›å»ºå·¥å•                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. å•†æˆ·ä¸Šä¼ è¯æ®                                      â”‚
â”‚    POST /api/v1/disputes/{id}/evidence              â”‚
â”‚    - ä¸Šä¼ æ–‡ä»¶åˆ°S3/OSS                                â”‚
â”‚    - ä¿å­˜è¯æ®URLåˆ°æ•°æ®åº“                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. è‡ªåŠ¨æäº¤åˆ°Stripe                                  â”‚
â”‚    POST /v1/disputes/{id}                           â”‚
â”‚    - evidence[customer_name]                        â”‚
â”‚    - evidence[receipt]                              â”‚
â”‚    - submit=true                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. è·Ÿè¸ªç»“æœ                                          â”‚
â”‚    Webhook: dispute.won / dispute.lost              â”‚
â”‚    - æ›´æ–°status                                      â”‚
â”‚    - é€šçŸ¥å•†æˆ·                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒä»£ç 

```go
// backend/services/payment-gateway/internal/service/dispute_service.go

package service

type DisputeService interface {
    // Webhookæ¥æ”¶æ‹’ä»˜é€šçŸ¥
    HandleDisputeWebhook(ctx context.Context, event *stripe.Event) error

    // è·å–æ‹’ä»˜è¯¦æƒ…
    GetDispute(ctx context.Context, id uuid.UUID) (*Dispute, error)

    // å•†æˆ·ä¸Šä¼ è¯æ®
    UploadEvidence(ctx context.Context, disputeID uuid.UUID, evidence *EvidenceInput) error

    // è‡ªåŠ¨æäº¤è¯æ®åˆ°Stripe
    SubmitEvidenceToStripe(ctx context.Context, disputeID uuid.UUID) error

    // æ‹’ä»˜åˆ—è¡¨
    ListDisputes(ctx context.Context, query *DisputeQuery) ([]*Dispute, int64, error)

    // æ‹’ä»˜ç»Ÿè®¡
    GetDisputeStatistics(ctx context.Context, merchantID uuid.UUID, startDate, endDate time.Time) (*DisputeStats, error)
}

type Dispute struct {
    ID              uuid.UUID
    DisputeNo       string
    PaymentID       uuid.UUID
    PaymentNo       string
    MerchantID      uuid.UUID
    Channel         string  // "stripe", "paypal"
    ChannelDisputeID string
    Amount          int64
    Currency        string
    Reason          string  // "fraud", "duplicate", "product_not_received", "product_unacceptable"
    Status          string  // "warning", "needs_response", "under_review", "won", "lost", "expired"
    DueDate         *time.Time
    EvidenceFiles   []EvidenceFile
    SubmittedAt     *time.Time
    ResolvedAt      *time.Time
    Resolution      string
    CreatedAt       time.Time
}

type EvidenceFile struct {
    Type        string  // "receipt", "tracking", "customer_communication"
    FileName    string
    FileURL     string
    UploadedAt  time.Time
}
```

#### æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- æ‹’ä»˜è®°å½•è¡¨
CREATE TABLE disputes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dispute_no VARCHAR(100) UNIQUE NOT NULL,
    payment_id UUID NOT NULL REFERENCES payments(id),
    payment_no VARCHAR(100) NOT NULL,
    merchant_id UUID NOT NULL,
    channel VARCHAR(50) NOT NULL,
    channel_dispute_id VARCHAR(200) NOT NULL,
    amount BIGINT NOT NULL,
    currency VARCHAR(3) NOT NULL,
    reason VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'warning',
    due_date TIMESTAMP,
    evidence_details JSONB, -- è¯æ®è¯¦æƒ… (JSONæ ¼å¼)
    submitted_at TIMESTAMP,
    resolved_at TIMESTAMP,
    resolution TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    INDEX idx_payment_id (payment_id),
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_status (status),
    INDEX idx_due_date (due_date),
    UNIQUE INDEX idx_channel_dispute (channel, channel_dispute_id)
);

-- æ‹’ä»˜è¯æ®æ–‡ä»¶è¡¨
CREATE TABLE dispute_evidence_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dispute_id UUID NOT NULL REFERENCES disputes(id),
    file_type VARCHAR(50) NOT NULL, -- "receipt", "tracking", "communication"
    file_name VARCHAR(255) NOT NULL,
    file_url TEXT NOT NULL,
    file_size BIGINT,
    uploaded_by UUID,
    uploaded_at TIMESTAMP NOT NULL DEFAULT NOW(),
    INDEX idx_dispute_id (dispute_id)
);
```

---

### æ¨¡å—C: å•†æˆ·é¢åº¦ç®¡ç†

#### å•†æˆ·åˆ†çº§ä½“ç³»

```go
type MerchantTier string

const (
    TierStarter    MerchantTier = "starter"    // èµ·æ­¥çº§
    TierBusiness   MerchantTier = "business"   // å•†åŠ¡çº§
    TierEnterprise MerchantTier = "enterprise" // ä¼ä¸šçº§
    TierPremium    MerchantTier = "premium"    // é¡¶çº§
)

type TierConfig struct {
    Tier              MerchantTier
    MonthlyLimit      int64   // æœˆäº¤æ˜“é™é¢ (åˆ†)
    DailyLimit        int64   // æ—¥äº¤æ˜“é™é¢
    SingleLimit       int64   // å•ç¬”é™é¢
    FeeRate           int     // æ‰‹ç»­è´¹ç‡ (åŸºç‚¹, 1åŸºç‚¹=0.01%)
    SettlementCycle   string  // ç»“ç®—å‘¨æœŸ ("T+1", "T+0")
    SupportLevel      string  // å®¢æœç­‰çº§
    APIRateLimit      int     // APIè°ƒç”¨é¢‘ç‡ (æ¬¡/åˆ†é’Ÿ)
}

// é¢„è®¾åˆ†çº§é…ç½®
var DefaultTierConfigs = map[MerchantTier]*TierConfig{
    TierStarter: {
        MonthlyLimit:    10000000,  // 10ä¸‡å…ƒ
        DailyLimit:      500000,    // 5åƒå…ƒ
        SingleLimit:     100000,    // 1åƒå…ƒ
        FeeRate:         60,        // 0.6%
        SettlementCycle: "T+1",
        SupportLevel:    "standard",
        APIRateLimit:    100,
    },
    TierBusiness: {
        MonthlyLimit:    100000000, // 100ä¸‡å…ƒ
        DailyLimit:      5000000,   // 5ä¸‡å…ƒ
        SingleLimit:     1000000,   // 1ä¸‡å…ƒ
        FeeRate:         50,        // 0.5%
        SettlementCycle: "T+1",
        SupportLevel:    "priority",
        APIRateLimit:    500,
    },
    TierEnterprise: {
        MonthlyLimit:    1000000000, // 1000ä¸‡å…ƒ
        DailyLimit:      50000000,   // 50ä¸‡å…ƒ
        SingleLimit:     10000000,   // 10ä¸‡å…ƒ
        FeeRate:         40,         // 0.4%
        SettlementCycle: "T+0",
        SupportLevel:    "premium",
        APIRateLimit:    2000,
    },
    TierPremium: {
        MonthlyLimit:    -1,         // æ— é™åˆ¶
        DailyLimit:      -1,
        SingleLimit:     -1,
        FeeRate:         30,         // 0.3% (åå•†)
        SettlementCycle: "T+0",
        SupportLevel:    "dedicated",
        APIRateLimit:    10000,
    },
}
```

#### é¢åº¦æ£€æŸ¥æœåŠ¡

```go
// backend/services/merchant-service/internal/service/limit_service.go

package service

type LimitService interface {
    // æ£€æŸ¥é¢åº¦ (æ”¯ä»˜å‰è°ƒç”¨)
    CheckLimit(ctx context.Context, merchantID uuid.UUID, amount int64) (*LimitCheckResult, error)

    // æ‰£å‡é¢åº¦ (æ”¯ä»˜æˆåŠŸåè°ƒç”¨)
    DeductLimit(ctx context.Context, merchantID uuid.UUID, amount int64) error

    // æ¢å¤é¢åº¦ (é€€æ¬¾åè°ƒç”¨)
    RestoreLimit(ctx context.Context, merchantID uuid.UUID, amount int64) error

    // è·å–é¢åº¦ä½¿ç”¨æƒ…å†µ
    GetLimitUsage(ctx context.Context, merchantID uuid.UUID) (*LimitUsage, error)

    // è°ƒæ•´é¢åº¦ (è¿è¥æ‰‹åŠ¨è°ƒæ•´)
    AdjustLimit(ctx context.Context, merchantID uuid.UUID, newTier MerchantTier, customLimits *CustomLimits) error
}

type LimitCheckResult struct {
    Allowed         bool
    RemainingDaily  int64
    RemainingMonthly int64
    Reason          string  // è¶…é™åŸå› 
}

type LimitUsage struct {
    Tier              MerchantTier
    DailyLimit        int64
    DailyUsed         int64
    DailyRemaining    int64
    MonthlyLimit      int64
    MonthlyUsed       int64
    MonthlyRemaining  int64
    SingleLimit       int64
}

// Redis Keyè®¾è®¡
const (
    KeyDailyLimit  = "merchant:limit:daily:{merchant_id}:{date}"    // TTL: 24å°æ—¶
    KeyMonthlyLimit = "merchant:limit:monthly:{merchant_id}:{month}" // TTL: 31å¤©
)

// å®ç°ç¤ºä¾‹
func (s *limitService) CheckLimit(ctx context.Context, merchantID uuid.UUID, amount int64) (*LimitCheckResult, error) {
    // 1. è·å–å•†æˆ·åˆ†çº§é…ç½®
    merchant, err := s.merchantRepo.GetByID(ctx, merchantID)
    if err != nil {
        return nil, err
    }

    config := DefaultTierConfigs[merchant.Tier]

    // 2. æ£€æŸ¥å•ç¬”é™é¢
    if config.SingleLimit > 0 && amount > config.SingleLimit {
        return &LimitCheckResult{
            Allowed: false,
            Reason:  fmt.Sprintf("è¶…è¿‡å•ç¬”é™é¢: %.2få…ƒ", float64(config.SingleLimit)/100),
        }, nil
    }

    // 3. æ£€æŸ¥æ—¥é™é¢
    today := time.Now().Format("20060102")
    dailyKey := fmt.Sprintf("merchant:limit:daily:%s:%s", merchantID, today)
    dailyUsed, _ := s.redisClient.Get(ctx, dailyKey).Int64()

    if config.DailyLimit > 0 && (dailyUsed + amount) > config.DailyLimit {
        return &LimitCheckResult{
            Allowed:        false,
            RemainingDaily: max(0, config.DailyLimit - dailyUsed),
            Reason:         "è¶…è¿‡æ—¥é™é¢",
        }, nil
    }

    // 4. æ£€æŸ¥æœˆé™é¢
    month := time.Now().Format("200601")
    monthlyKey := fmt.Sprintf("merchant:limit:monthly:%s:%s", merchantID, month)
    monthlyUsed, _ := s.redisClient.Get(ctx, monthlyKey).Int64()

    if config.MonthlyLimit > 0 && (monthlyUsed + amount) > config.MonthlyLimit {
        return &LimitCheckResult{
            Allowed:          false,
            RemainingMonthly: max(0, config.MonthlyLimit - monthlyUsed),
            Reason:           "è¶…è¿‡æœˆé™é¢",
        }, nil
    }

    return &LimitCheckResult{
        Allowed:          true,
        RemainingDaily:   config.DailyLimit - dailyUsed - amount,
        RemainingMonthly: config.MonthlyLimit - monthlyUsed - amount,
    }, nil
}
```

#### æ•°æ®åº“è¡¨è®¾è®¡

```sql
-- æ‰©å±•å•†æˆ·è¡¨
ALTER TABLE merchants
ADD COLUMN tier VARCHAR(20) NOT NULL DEFAULT 'starter',
ADD COLUMN custom_daily_limit BIGINT,
ADD COLUMN custom_monthly_limit BIGINT,
ADD COLUMN custom_single_limit BIGINT,
ADD COLUMN custom_fee_rate INT,
ADD INDEX idx_tier (tier);

-- é¢åº¦ä½¿ç”¨å†å²è¡¨ (ç”¨äºå¯¹è´¦å’Œå®¡è®¡)
CREATE TABLE merchant_limit_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    merchant_id UUID NOT NULL,
    usage_date DATE NOT NULL,
    tier VARCHAR(20) NOT NULL,
    daily_limit BIGINT NOT NULL,
    daily_used BIGINT NOT NULL DEFAULT 0,
    monthly_limit BIGINT NOT NULL,
    monthly_used BIGINT NOT NULL DEFAULT 0,
    transaction_count INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE INDEX idx_merchant_date (merchant_id, usage_date)
);
```

---

### æ¨¡å—D: PayPalé›†æˆ

#### æ¥å…¥æ–¹æ¡ˆ

PayPalæä¾›ä¸¤ç§é›†æˆæ–¹å¼ï¼Œæˆ‘ä»¬é€‰æ‹© **Orders API v2** (æ¨è)ï¼š

```
Orders API v2:
- æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼ (ä¿¡ç”¨å¡, PayPalä½™é¢, BNPL)
- ç»Ÿä¸€çš„Webhookäº‹ä»¶
- æ›´å¥½çš„é”™è¯¯å¤„ç†
```

#### æ ¸å¿ƒæµç¨‹

```go
// backend/services/channel-adapter/internal/adapter/paypal_adapter.go

package adapter

import (
    "github.com/plutov/paypal/v4"
)

type PayPalAdapter struct {
    client *paypal.Client
    config *PayPalConfig
}

type PayPalConfig struct {
    ClientID     string
    ClientSecret string
    Mode         string // "sandbox" or "live"
    WebhookID    string
}

func NewPayPalAdapter(config *PayPalConfig) *PayPalAdapter {
    client, _ := paypal.NewClient(config.ClientID, config.ClientSecret, config.Mode)
    return &PayPalAdapter{
        client: client,
        config: config,
    }
}

// å®ç°PaymentAdapteræ¥å£
func (a *PayPalAdapter) CreatePayment(ctx context.Context, req *CreatePaymentRequest) (*CreatePaymentResponse, error) {
    // 1. åˆ›å»ºPayPalè®¢å•
    order, err := a.client.CreateOrder(ctx, paypal.OrderIntentCapture, []paypal.PurchaseUnitRequest{
        {
            Amount: &paypal.PurchaseUnitAmount{
                Currency: req.Currency,
                Value:    fmt.Sprintf("%.2f", float64(req.Amount)/100),
            },
            ReferenceID: req.PaymentNo,
            CustomID:    req.MerchantID,
        },
    }, &paypal.CreateOrderPayer{}, &paypal.ApplicationContext{
        BrandName:  "Your Payment Platform",
        ReturnURL:  req.ReturnURL,
        CancelURL:  req.ReturnURL + "?cancelled=true",
    })

    if err != nil {
        return nil, fmt.Errorf("PayPal CreateOrder failed: %w", err)
    }

    // 2. æå–Approveé“¾æ¥
    var approveURL string
    for _, link := range order.Links {
        if link.Rel == "approve" {
            approveURL = link.Href
            break
        }
    }

    return &CreatePaymentResponse{
        ChannelOrderNo: order.ID,
        PaymentURL:     approveURL,
        Status:         "pending_approval",
    }, nil
}

func (a *PayPalAdapter) CapturePayment(ctx context.Context, orderID string) error {
    // æ•è·æˆæƒçš„è®¢å• (ç”¨æˆ·å®Œæˆæˆæƒåè°ƒç”¨)
    _, err := a.client.CaptureOrder(ctx, orderID, paypal.CaptureOrderRequest{})
    return err
}

func (a *PayPalAdapter) CreateRefund(ctx context.Context, req *RefundRequest) (*RefundResponse, error) {
    // PayPalé€€æ¬¾
    refund, err := a.client.RefundCapture(ctx, req.ChannelOrderNo, &paypal.RefundCaptureRequest{
        Amount: &paypal.Money{
            Currency: req.Currency,
            Value:    fmt.Sprintf("%.2f", float64(req.Amount)/100),
        },
    })

    if err != nil {
        return nil, err
    }

    return &RefundResponse{
        ChannelRefundNo: refund.ID,
        Status:          refund.Status,
    }, nil
}
```

#### WebhookéªŒè¯

```go
func (a *PayPalAdapter) VerifyWebhook(ctx context.Context, headers map[string]string, body []byte) (*paypal.WebhookEvent, error) {
    // PayPal Webhookç­¾åéªŒè¯
    event, err := paypal.VerifyWebhookSignature(ctx, a.client,
        headers["PAYPAL-TRANSMISSION-ID"],
        headers["PAYPAL-TRANSMISSION-TIME"],
        a.config.WebhookID,
        body,
        headers["PAYPAL-TRANSMISSION-SIG"],
        headers["PAYPAL-CERT-URL"],
        headers["PAYPAL-AUTH-ALGO"],
    )

    return event, err
}
```

---

### æ¨¡å—E: æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜é›†æˆ

#### æ”¯ä»˜å®é›†æˆ

```go
// backend/services/channel-adapter/internal/adapter/alipay_adapter.go

package adapter

import (
    "github.com/smartwalle/alipay/v3"
)

type AlipayAdapter struct {
    client *alipay.Client
    config *AlipayConfig
}

type AlipayConfig struct {
    AppID          string
    PrivateKey     string  // åº”ç”¨ç§é’¥
    AlipayPublicKey string // æ”¯ä»˜å®å…¬é’¥
    NotifyURL      string
}

func NewAlipayAdapter(config *AlipayConfig) *AlipayAdapter {
    client, _ := alipay.New(config.AppID, config.PrivateKey, false)
    client.LoadAliPayPublicKey(config.AlipayPublicKey)

    return &AlipayAdapter{
        client: client,
        config: config,
    }
}

// APPæ”¯ä»˜
func (a *AlipayAdapter) CreateAppPayment(ctx context.Context, req *CreatePaymentRequest) (*CreatePaymentResponse, error) {
    pay := alipay.TradeAppPay{
        Trade: alipay.Trade{
            Subject:     req.Description,
            OutTradeNo:  req.PaymentNo,
            TotalAmount: fmt.Sprintf("%.2f", float64(req.Amount)/100),
            NotifyURL:   a.config.NotifyURL,
        },
    }

    payParam, err := a.client.TradeAppPay(pay)
    if err != nil {
        return nil, err
    }

    return &CreatePaymentResponse{
        ChannelOrderNo: req.PaymentNo,
        PaymentURL:     payParam.String(), // APPè°ƒèµ·å‚æ•°
        Status:         "pending",
    }, nil
}

// ç½‘é¡µæ”¯ä»˜
func (a *AlipayAdapter) CreatePagePayment(ctx context.Context, req *CreatePaymentRequest) (*CreatePaymentResponse, error) {
    pay := alipay.TradePagePay{
        Trade: alipay.Trade{
            Subject:     req.Description,
            OutTradeNo:  req.PaymentNo,
            TotalAmount: fmt.Sprintf("%.2f", float64(req.Amount)/100),
            NotifyURL:   a.config.NotifyURL,
        },
        ReturnURL: req.ReturnURL,
    }

    payURL, err := a.client.TradePagePay(pay)
    if err != nil {
        return nil, err
    }

    return &CreatePaymentResponse{
        ChannelOrderNo: req.PaymentNo,
        PaymentURL:     payURL.String(),
        Status:         "pending",
    }, nil
}

// æ‰«ç æ”¯ä»˜
func (a *AlipayAdapter) CreateQRPayment(ctx context.Context, req *CreatePaymentRequest) (*CreatePaymentResponse, error) {
    pay := alipay.TradePrecreate{
        Trade: alipay.Trade{
            Subject:     req.Description,
            OutTradeNo:  req.PaymentNo,
            TotalAmount: fmt.Sprintf("%.2f", float64(req.Amount)/100),
            NotifyURL:   a.config.NotifyURL,
        },
    }

    rsp, err := a.client.TradePrecreate(pay)
    if err != nil {
        return nil, err
    }

    return &CreatePaymentResponse{
        ChannelOrderNo: req.PaymentNo,
        QRCodeURL:      rsp.Content.QRCode, // äºŒç»´ç URL
        Status:         "pending",
    }, nil
}

// é€€æ¬¾
func (a *AlipayAdapter) CreateRefund(ctx context.Context, req *RefundRequest) (*RefundResponse, error) {
    refund := alipay.TradeRefund{
        OutTradeNo:   req.PaymentNo,
        RefundAmount: fmt.Sprintf("%.2f", float64(req.Amount)/100),
        RefundReason: req.Reason,
    }

    rsp, err := a.client.TradeRefund(refund)
    if err != nil {
        return nil, err
    }

    return &RefundResponse{
        ChannelRefundNo: rsp.Content.TradeNo,
        Status:          "success",
    }, nil
}
```

#### å¾®ä¿¡æ”¯ä»˜é›†æˆ

```go
// backend/services/channel-adapter/internal/adapter/wechat_adapter.go

package adapter

import (
    "github.com/wechatpay-apiv3/wechatpay-go/core"
    "github.com/wechatpay-apiv3/wechatpay-go/services/payments/app"
    "github.com/wechatpay-apiv3/wechatpay-go/services/payments/jsapi"
    "github.com/wechatpay-apiv3/wechatpay-go/services/payments/native"
)

type WechatAdapter struct {
    client *core.Client
    config *WechatConfig
}

type WechatConfig struct {
    MchID       string // å•†æˆ·å·
    AppID       string
    APIv3Key    string // APIv3å¯†é’¥
    SerialNo    string // è¯ä¹¦åºåˆ—å·
    PrivateKey  string // å•†æˆ·ç§é’¥
    NotifyURL   string
}

// APPæ”¯ä»˜
func (a *WechatAdapter) CreateAppPayment(ctx context.Context, req *CreatePaymentRequest) (*CreatePaymentResponse, error) {
    svc := app.AppApiService{Client: a.client}

    resp, _, err := svc.Prepay(ctx, app.PrepayRequest{
        Appid:       core.String(a.config.AppID),
        Mchid:       core.String(a.config.MchID),
        Description: core.String(req.Description),
        OutTradeNo:  core.String(req.PaymentNo),
        NotifyUrl:   core.String(a.config.NotifyURL),
        Amount: &app.Amount{
            Total:    core.Int64(req.Amount),
            Currency: core.String(req.Currency),
        },
    })

    if err != nil {
        return nil, err
    }

    return &CreatePaymentResponse{
        ChannelOrderNo: req.PaymentNo,
        PaymentURL:     *resp.PrepayId, // APPè°ƒèµ·å‚æ•°
        Status:         "pending",
    }, nil
}

// JSAPIæ”¯ä»˜ (å°ç¨‹åº/å…¬ä¼—å·)
func (a *WechatAdapter) CreateJSAPIPayment(ctx context.Context, req *CreatePaymentRequest) (*CreatePaymentResponse, error) {
    svc := jsapi.JsapiApiService{Client: a.client}

    resp, _, err := svc.Prepay(ctx, jsapi.PrepayRequest{
        Appid:       core.String(a.config.AppID),
        Mchid:       core.String(a.config.MchID),
        Description: core.String(req.Description),
        OutTradeNo:  core.String(req.PaymentNo),
        NotifyUrl:   core.String(a.config.NotifyURL),
        Amount: &jsapi.Amount{
            Total: core.Int64(req.Amount),
        },
        Payer: &jsapi.Payer{
            Openid: core.String(req.Extra["openid"].(string)),
        },
    })

    if err != nil {
        return nil, err
    }

    return &CreatePaymentResponse{
        ChannelOrderNo: req.PaymentNo,
        PaymentURL:     *resp.PrepayId,
        Status:         "pending",
    }, nil
}

// Nativeæ”¯ä»˜ (æ‰«ç )
func (a *WechatAdapter) CreateNativePayment(ctx context.Context, req *CreatePaymentRequest) (*CreatePaymentResponse, error) {
    svc := native.NativeApiService{Client: a.client}

    resp, _, err := svc.Prepay(ctx, native.PrepayRequest{
        Appid:       core.String(a.config.AppID),
        Mchid:       core.String(a.config.MchID),
        Description: core.String(req.Description),
        OutTradeNo:  core.String(req.PaymentNo),
        NotifyUrl:   core.String(a.config.NotifyURL),
        Amount: &native.Amount{
            Total: core.Int64(req.Amount),
        },
    })

    if err != nil {
        return nil, err
    }

    return &CreatePaymentResponse{
        ChannelOrderNo: req.PaymentNo,
        QRCodeURL:      *resp.CodeUrl, // äºŒç»´ç URL
        Status:         "pending",
    }, nil
}
```

---

### æ¨¡å—H: æ”¯ä»˜è¶…æ—¶å¤„ç†

#### å®šæ—¶ä»»åŠ¡è®¾è®¡

```go
// backend/services/payment-gateway/internal/service/timeout_service.go

package service

import (
    "context"
    "time"
)

type TimeoutService interface {
    // æ‰«æè¶…æ—¶è®¢å•
    ScanExpiredPayments(ctx context.Context) error

    // å¤„ç†å•ä¸ªè¶…æ—¶è®¢å•
    HandleExpiredPayment(ctx context.Context, payment *model.Payment) error
}

type timeoutService struct {
    paymentRepo   repository.PaymentRepository
    orderClient   *client.OrderClient
    channelClient *client.ChannelClient
    notificationClient *client.NotificationClient
}

func NewTimeoutService(...) TimeoutService {
    return &timeoutService{...}
}

// å®šæ—¶ä»»åŠ¡: æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
func (s *timeoutService) ScanExpiredPayments(ctx context.Context) error {
    logger.Info("å¼€å§‹æ‰«æè¶…æ—¶è®¢å•")

    // æŸ¥è¯¢è¶…æ—¶çš„pendingè®¢å•
    query := &repository.PaymentQuery{
        Status:     model.PaymentStatusPending,
        ExpiredBefore: time.Now(),
        PageSize:   100,
    }

    payments, _, err := s.paymentRepo.List(ctx, query)
    if err != nil {
        return fmt.Errorf("æŸ¥è¯¢è¶…æ—¶è®¢å•å¤±è´¥: %w", err)
    }

    logger.Info("å‘ç°è¶…æ—¶è®¢å•", zap.Int("count", len(payments)))

    // å¹¶å‘å¤„ç†
    var wg sync.WaitGroup
    semaphore := make(chan struct{}, 10) // é™åˆ¶å¹¶å‘æ•°

    for _, payment := range payments {
        wg.Add(1)
        semaphore <- struct{}{}

        go func(p *model.Payment) {
            defer wg.Done()
            defer func() { <-semaphore }()

            if err := s.HandleExpiredPayment(ctx, p); err != nil {
                logger.Error("å¤„ç†è¶…æ—¶è®¢å•å¤±è´¥",
                    zap.String("payment_no", p.PaymentNo),
                    zap.Error(err))
            }
        }(payment)
    }

    wg.Wait()
    logger.Info("è¶…æ—¶è®¢å•å¤„ç†å®Œæˆ")
    return nil
}

func (s *timeoutService) HandleExpiredPayment(ctx context.Context, payment *model.Payment) error {
    logger.Info("å¤„ç†è¶…æ—¶è®¢å•", zap.String("payment_no", payment.PaymentNo))

    // 1. è°ƒç”¨æ¸ é“å–æ¶ˆè®¢å•
    if s.channelClient != nil {
        if err := s.channelClient.CancelPayment(ctx, payment.Channel, payment.ChannelOrderNo); err != nil {
            logger.Warn("æ¸ é“å–æ¶ˆå¤±è´¥,ç»§ç»­æ›´æ–°æœ¬åœ°çŠ¶æ€",
                zap.Error(err),
                zap.String("payment_no", payment.PaymentNo))
        }
    }

    // 2. æ›´æ–°æ”¯ä»˜çŠ¶æ€ä¸ºå·²å–æ¶ˆ
    payment.Status = model.PaymentStatusCancelled
    payment.ErrorMsg = "æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ"
    payment.ErrorCode = "TIMEOUT"

    if err := s.paymentRepo.Update(ctx, payment); err != nil {
        return fmt.Errorf("æ›´æ–°æ”¯ä»˜çŠ¶æ€å¤±è´¥: %w", err)
    }

    // 3. é€šçŸ¥Order Service
    if s.orderClient != nil {
        s.orderClient.CancelOrder(ctx, payment.OrderNo, "æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ")
    }

    // 4. å‘é€é€šçŸ¥åˆ°å•†æˆ·
    if s.notificationClient != nil {
        go s.sendTimeoutNotification(payment)
    }

    logger.Info("è¶…æ—¶è®¢å•å¤„ç†æˆåŠŸ", zap.String("payment_no", payment.PaymentNo))
    return nil
}

func (s *timeoutService) sendTimeoutNotification(payment *model.Payment) {
    ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
    defer cancel()

    s.notificationClient.SendPaymentNotification(ctx, &client.SendNotificationRequest{
        MerchantID: payment.MerchantID,
        Type:       "payment_timeout",
        Title:      "æ”¯ä»˜è¶…æ—¶",
        Content:    fmt.Sprintf("è®¢å• %s å·²è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ", payment.OrderNo),
        Priority:   "normal",
        Data: map[string]interface{}{
            "payment_no": payment.PaymentNo,
            "order_no":   payment.OrderNo,
            "amount":     payment.Amount,
        },
    })
}
```

#### Cronä»»åŠ¡é…ç½®

```go
// backend/services/payment-gateway/cmd/main.go

import "github.com/robfig/cron/v3"

func setupCronJobs(timeoutService service.TimeoutService) {
    c := cron.New()

    // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    c.AddFunc("*/5 * * * *", func() {
        ctx := context.Background()
        if err := timeoutService.ScanExpiredPayments(ctx); err != nil {
            logger.Error("è¶…æ—¶è®¢å•æ‰«æå¤±è´¥", zap.Error(err))
        }
    })

    c.Start()
    logger.Info("å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨")
}
```

---

### æ¨¡å—M: ç¾å¤‡ä¸é«˜å¯ç”¨

#### æ¶æ„è®¾è®¡

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  Load Balancer  â”‚
                         â”‚   (Kong/Nginx)  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚               â”‚               â”‚
              â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
              â”‚ Service â”‚     â”‚ Service â”‚     â”‚ Service â”‚
              â”‚ Pod 1   â”‚     â”‚ Pod 2   â”‚     â”‚ Pod 3   â”‚
              â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                  â”‚               â”‚               â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PostgreSQL    â”‚              â”‚  Redis Cluster â”‚
          â”‚  Primary       â”‚â—„â”€â”€Replâ”€â”€â”€â”€â”€â”€â”€â”¤  Sentinel      â”‚
          â”‚                â”‚              â”‚                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  PostgreSQL    â”‚
          â”‚  Standby       â”‚
          â”‚  (Failover)    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### PostgreSQLé«˜å¯ç”¨ (Patroni)

```yaml
# docker-compose-ha.yml

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    environment:
      ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
      ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
    ports:
      - "2379:2379"

  postgres-primary:
    image: patroni/patroni:latest
    environment:
      PATRONI_NAME: postgres1
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data
      PATRONI_ETCD_HOSTS: etcd:2379
      PATRONI_SCOPE: payment-cluster
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:8008
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:5432
      PATRONI_SUPERUSER_PASSWORD: postgres
      PATRONI_REPLICATION_USERNAME: replicator
      PATRONI_REPLICATION_PASSWORD: replicator
    ports:
      - "40432:5432"
      - "40433:8008"
    volumes:
      - postgres-primary-data:/var/lib/postgresql/data

  postgres-standby:
    image: patroni/patroni:latest
    environment:
      PATRONI_NAME: postgres2
      PATRONI_POSTGRESQL_DATA_DIR: /var/lib/postgresql/data
      PATRONI_ETCD_HOSTS: etcd:2379
      PATRONI_SCOPE: payment-cluster
      PATRONI_RESTAPI_LISTEN: 0.0.0.0:8008
      PATRONI_POSTGRESQL_LISTEN: 0.0.0.0:5432
      PATRONI_SUPERUSER_PASSWORD: postgres
      PATRONI_REPLICATION_USERNAME: replicator
      PATRONI_REPLICATION_PASSWORD: replicator
    ports:
      - "40434:5432"
      - "40435:8008"
    volumes:
      - postgres-standby-data:/var/lib/postgresql/data
```

#### Redis Sentinel

```yaml
redis-master:
  image: redis:7-alpine
  command: redis-server --appendonly yes
  ports:
    - "40379:6379"
  volumes:
    - redis-master-data:/data

redis-slave:
  image: redis:7-alpine
  command: redis-server --appendonly yes --slaveof redis-master 6379
  ports:
    - "40380:6379"
  volumes:
    - redis-slave-data:/data

redis-sentinel:
  image: redis:7-alpine
  command: >
    sh -c "echo 'sentinel monitor mymaster redis-master 6379 2' > /etc/redis/sentinel.conf &&
           echo 'sentinel down-after-milliseconds mymaster 5000' >> /etc/redis/sentinel.conf &&
           echo 'sentinel parallel-syncs mymaster 1' >> /etc/redis/sentinel.conf &&
           echo 'sentinel failover-timeout mymaster 10000' >> /etc/redis/sentinel.conf &&
           redis-sentinel /etc/redis/sentinel.conf"
  ports:
    - "26379:26379"
```

#### å¤‡ä»½ç­–ç•¥

```bash
#!/bin/bash
# backend/scripts/backup-postgres.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"

# å…¨é‡å¤‡ä»½
pg_dump -h localhost -p 40432 -U postgres \
    -F custom -f "$BACKUP_DIR/full_backup_$DATE.dump" \
    payment_platform

# ä¸Šä¼ åˆ°S3/OSS
aws s3 cp "$BACKUP_DIR/full_backup_$DATE.dump" \
    s3://payment-backups/postgres/

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.dump" -mtime +7 -delete

# Croné…ç½®: æ¯æ—¥å‡Œæ™¨3ç‚¹æ‰§è¡Œ
# 0 3 * * * /app/scripts/backup-postgres.sh
```

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### æ–°å¢è¡¨æ±‡æ€»

```sql
-- ========== æ¨¡å—A: å¯¹è´¦ç³»ç»Ÿ ==========
CREATE TABLE reconciliation_reports (...);
CREATE TABLE reconciliation_discrepancies (...);

-- ========== æ¨¡å—B: æ‹’ä»˜ç®¡ç† ==========
CREATE TABLE disputes (...);
CREATE TABLE dispute_evidence_files (...);

-- ========== æ¨¡å—C: å•†æˆ·é¢åº¦ ==========
ALTER TABLE merchants ADD COLUMN tier VARCHAR(20);
CREATE TABLE merchant_limit_usage (...);

-- ========== æ¨¡å—D/E: æ¸ é“æ‰©å±• (æ— æ–°è¡¨,å¤ç”¨payment_callbacks) ==========

-- ========== æ¨¡å—H: è¶…æ—¶å¤„ç† (æ— æ–°è¡¨,ä½¿ç”¨existing paymentè¡¨) ==========
```

### Schemaè¿ç§»è„šæœ¬

```sql
-- backend/migrations/V1.1__globalization_modules.sql

-- 1. å¯¹è´¦ç³»ç»Ÿ
CREATE TABLE IF NOT EXISTS reconciliation_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    reconcile_date DATE NOT NULL,
    channel VARCHAR(50) NOT NULL,
    total_internal BIGINT NOT NULL,
    total_channel BIGINT NOT NULL,
    matched BIGINT NOT NULL,
    missing BIGINT NOT NULL,
    duplicate BIGINT NOT NULL,
    amount_mismatch BIGINT NOT NULL,
    match_rate DECIMAL(5,2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    report_file_url TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMP,
    reviewed_by UUID,
    reviewed_at TIMESTAMP
);

CREATE INDEX idx_reconcile_date ON reconciliation_reports(reconcile_date);
CREATE INDEX idx_reconcile_status ON reconciliation_reports(status);

CREATE TABLE IF NOT EXISTS reconciliation_discrepancies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    report_id UUID NOT NULL REFERENCES reconciliation_reports(id) ON DELETE CASCADE,
    type VARCHAR(20) NOT NULL,
    internal_order_no VARCHAR(100),
    channel_order_no VARCHAR(100),
    internal_amount BIGINT,
    channel_amount BIGINT,
    amount_diff BIGINT,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    resolution TEXT,
    resolved_by UUID,
    resolved_at TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_discrepancy_report ON reconciliation_discrepancies(report_id);
CREATE INDEX idx_discrepancy_status ON reconciliation_discrepancies(status);

-- 2. æ‹’ä»˜ç®¡ç†
CREATE TABLE IF NOT EXISTS disputes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dispute_no VARCHAR(100) UNIQUE NOT NULL,
    payment_id UUID NOT NULL REFERENCES payments(id) ON DELETE RESTRICT,
    payment_no VARCHAR(100) NOT NULL,
    merchant_id UUID NOT NULL,
    channel VARCHAR(50) NOT NULL,
    channel_dispute_id VARCHAR(200) NOT NULL,
    amount BIGINT NOT NULL,
    currency VARCHAR(3) NOT NULL,
    reason VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'warning',
    due_date TIMESTAMP,
    evidence_details JSONB,
    submitted_at TIMESTAMP,
    resolved_at TIMESTAMP,
    resolution TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_dispute_payment ON disputes(payment_id);
CREATE INDEX idx_dispute_merchant ON disputes(merchant_id);
CREATE INDEX idx_dispute_status ON disputes(status);
CREATE UNIQUE INDEX idx_dispute_channel ON disputes(channel, channel_dispute_id);

CREATE TABLE IF NOT EXISTS dispute_evidence_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    dispute_id UUID NOT NULL REFERENCES disputes(id) ON DELETE CASCADE,
    file_type VARCHAR(50) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_url TEXT NOT NULL,
    file_size BIGINT,
    uploaded_by UUID,
    uploaded_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_evidence_dispute ON dispute_evidence_files(dispute_id);

-- 3. å•†æˆ·é¢åº¦
ALTER TABLE merchants
ADD COLUMN IF NOT EXISTS tier VARCHAR(20) NOT NULL DEFAULT 'starter',
ADD COLUMN IF NOT EXISTS custom_daily_limit BIGINT,
ADD COLUMN IF NOT EXISTS custom_monthly_limit BIGINT,
ADD COLUMN IF NOT EXISTS custom_single_limit BIGINT,
ADD COLUMN IF NOT EXISTS custom_fee_rate INT;

CREATE INDEX IF NOT EXISTS idx_merchant_tier ON merchants(tier);

CREATE TABLE IF NOT EXISTS merchant_limit_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    merchant_id UUID NOT NULL REFERENCES merchants(id) ON DELETE CASCADE,
    usage_date DATE NOT NULL,
    tier VARCHAR(20) NOT NULL,
    daily_limit BIGINT NOT NULL,
    daily_used BIGINT NOT NULL DEFAULT 0,
    monthly_limit BIGINT NOT NULL,
    monthly_used BIGINT NOT NULL DEFAULT 0,
    transaction_count INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (merchant_id, usage_date)
);

-- 4. æ”¯ä»˜è¶…æ—¶å¤„ç† (æ— æ–°è¡¨,ç¡®ä¿expired_atå­—æ®µå­˜åœ¨)
ALTER TABLE payments
ADD COLUMN IF NOT EXISTS expired_at TIMESTAMP;

CREATE INDEX IF NOT EXISTS idx_payment_expired ON payments(expired_at)
WHERE status = 'pending' AND expired_at IS NOT NULL;
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### æ¨¡å—A: å¯¹è´¦ç³»ç»Ÿ API

```
POST   /api/v1/reconciliation/run              # æ‰‹åŠ¨è§¦å‘å¯¹è´¦
GET    /api/v1/reconciliation/reports          # å¯¹è´¦æŠ¥è¡¨åˆ—è¡¨
GET    /api/v1/reconciliation/reports/:id      # å¯¹è´¦æŠ¥è¡¨è¯¦æƒ…
GET    /api/v1/reconciliation/discrepancies    # å·®å¼‚åˆ—è¡¨
PUT    /api/v1/reconciliation/discrepancies/:id/resolve  # å¤„ç†å·®å¼‚
GET    /api/v1/reconciliation/statistics       # å¯¹è´¦ç»Ÿè®¡
```

### æ¨¡å—B: æ‹’ä»˜ç®¡ç† API

```
GET    /api/v1/disputes                        # æ‹’ä»˜åˆ—è¡¨
GET    /api/v1/disputes/:id                    # æ‹’ä»˜è¯¦æƒ…
POST   /api/v1/disputes/:id/evidence           # ä¸Šä¼ è¯æ®
POST   /api/v1/disputes/:id/submit             # æäº¤è¯æ®åˆ°æ¸ é“
GET    /api/v1/disputes/statistics             # æ‹’ä»˜ç»Ÿè®¡
POST   /webhooks/stripe/disputes               # Stripeæ‹’ä»˜Webhook
```

### æ¨¡å—C: å•†æˆ·é¢åº¦ API

```
GET    /api/v1/merchants/:id/limits            # æŸ¥è¯¢å•†æˆ·é¢åº¦
GET    /api/v1/merchants/:id/limits/usage      # é¢åº¦ä½¿ç”¨æƒ…å†µ
PUT    /api/v1/merchants/:id/limits            # è°ƒæ•´é¢åº¦
GET    /api/v1/merchants/:id/tier              # æŸ¥è¯¢å•†æˆ·åˆ†çº§
PUT    /api/v1/merchants/:id/tier              # è°ƒæ•´åˆ†çº§
GET    /api/v1/tiers                           # åˆ†çº§é…ç½®åˆ—è¡¨
```

### æ¨¡å—D: PayPal API

```
POST   /api/v1/payments/paypal                 # åˆ›å»ºPayPalæ”¯ä»˜
GET    /api/v1/payments/paypal/:id/capture     # æ•è·æˆæƒ
POST   /api/v1/refunds/paypal                  # PayPalé€€æ¬¾
POST   /webhooks/paypal                        # PayPal Webhook
```

### æ¨¡å—E: æ”¯ä»˜å®/å¾®ä¿¡ API

```
POST   /api/v1/payments/alipay/app             # æ”¯ä»˜å®APPæ”¯ä»˜
POST   /api/v1/payments/alipay/page            # æ”¯ä»˜å®ç½‘é¡µæ”¯ä»˜
POST   /api/v1/payments/alipay/qr              # æ”¯ä»˜å®æ‰«ç æ”¯ä»˜
POST   /api/v1/payments/wechat/app             # å¾®ä¿¡APPæ”¯ä»˜
POST   /api/v1/payments/wechat/jsapi           # å¾®ä¿¡JSAPIæ”¯ä»˜
POST   /api/v1/payments/wechat/native          # å¾®ä¿¡Nativeæ”¯ä»˜
POST   /webhooks/alipay                        # æ”¯ä»˜å®é€šçŸ¥
POST   /webhooks/wechat                        # å¾®ä¿¡é€šçŸ¥
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### Kuberneteséƒ¨ç½²æ–¹æ¡ˆ

```yaml
# k8s/payment-gateway-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: payment-gateway
  namespace: payment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: payment-gateway
  template:
    metadata:
      labels:
        app: payment-gateway
    spec:
      containers:
      - name: payment-gateway
        image: payment-platform/payment-gateway:v1.1.0
        ports:
        - containerPort: 40003
        env:
        - name: DB_HOST
          value: "postgres-primary.payment.svc.cluster.local"
        - name: REDIS_HOST
          value: "redis-sentinel.payment.svc.cluster.local"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 40003
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 40003
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: payment-gateway
  namespace: payment
spec:
  selector:
    app: payment-gateway
  ports:
  - protocol: TCP
    port: 40003
    targetPort: 40003
  type: ClusterIP

---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: payment-gateway-hpa
  namespace: payment
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: payment-gateway
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯• (200+ç”¨ä¾‹)

| æ¨¡å— | æµ‹è¯•ç”¨ä¾‹æ•° | è¦†ç›–ç‡ç›®æ ‡ |
|------|-----------|-----------|
| å¯¹è´¦ç³»ç»Ÿ | 40 | 90% |
| æ‹’ä»˜ç®¡ç† | 30 | 85% |
| å•†æˆ·é¢åº¦ | 35 | 90% |
| PayPalé›†æˆ | 25 | 80% |
| æ”¯ä»˜å®/å¾®ä¿¡ | 40 | 80% |
| è¶…æ—¶å¤„ç† | 20 | 95% |
| å…¶ä»– | 10 | 80% |

### é›†æˆæµ‹è¯•åœºæ™¯

```
åœºæ™¯1: å®Œæ•´æ”¯ä»˜æµç¨‹ (Stripe â†’ PayPal â†’ æ”¯ä»˜å® â†’ å¾®ä¿¡)
åœºæ™¯2: é€€æ¬¾æµç¨‹ (éƒ¨åˆ†é€€æ¬¾ + å…¨é¢é€€æ¬¾)
åœºæ™¯3: æ‹’ä»˜æµç¨‹ (åˆ›å»º â†’ ä¸Šä¼ è¯æ® â†’ æäº¤ â†’ ç»“æœé€šçŸ¥)
åœºæ™¯4: å¯¹è´¦æµç¨‹ (ä¸‹è½½è´¦å• â†’ åŒ¹é… â†’ ç”ŸæˆæŠ¥è¡¨)
åœºæ™¯5: é¢åº¦æ§åˆ¶ (è¶…æ—¥é™ â†’ è¶…æœˆé™ â†’ è¶…å•ç¬”é™)
åœºæ™¯6: è¶…æ—¶å¤„ç† (è®¢å•è¶…æ—¶ â†’ è‡ªåŠ¨å–æ¶ˆ â†’ é€šçŸ¥)
åœºæ™¯7: ç¾å¤‡åˆ‡æ¢ (ä¸»åº“æ•…éšœ â†’ è‡ªåŠ¨åˆ‡æ¢ â†’ æœåŠ¡æ¢å¤)
```

### å‹åŠ›æµ‹è¯•æŒ‡æ ‡

```
ç›®æ ‡TPS: 1000 (å¹¶å‘æ”¯ä»˜è¯·æ±‚)
ç›®æ ‡å»¶è¿Ÿ: P95 < 500ms, P99 < 1000ms
æˆåŠŸç‡: > 99.9%
å¹¶å‘å•†æˆ·: 1000+
æµ‹è¯•æ—¶é•¿: 1å°æ—¶æŒç»­å‹åŠ›
```

---

## âš ï¸ é£é™©ä¸åº”å¯¹

### æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| PayPal APIå˜æ›´ | é«˜ | ä¸­ | ä½¿ç”¨ç¨³å®šç‰ˆæœ¬,å®šæœŸæ£€æŸ¥changelog |
| æ”¯ä»˜å®/å¾®ä¿¡é™æµ | ä¸­ | é«˜ | å®ç°è¯·æ±‚é˜Ÿåˆ—,æ§åˆ¶é¢‘ç‡ |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | é«˜ | ä½ | è¯¦ç»†æµ‹è¯•,å¤‡ä»½æ•°æ®,å¯å›æ»š |
| Redisé›†ç¾¤æ•…éšœ | ä¸­ | ä½ | é™çº§åˆ°å•æœºæ¨¡å¼,ç›‘æ§å‘Šè­¦ |
| æ€§èƒ½ç“¶é¢ˆ | ä¸­ | ä¸­ | å‹æµ‹éªŒè¯,ä¼˜åŒ–æ…¢æŸ¥è¯¢ |

### ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| å¯¹è´¦å·®å¼‚è¿‡å¤š | é«˜ | ä¸­ | äººå·¥ä»‹å…¥æœºåˆ¶,å·®å¼‚åˆ†æå·¥å…· |
| æ‹’ä»˜ç‡ä¸Šå‡ | é«˜ | ä½ | é£æ§å‰ç½®,è¯æ®è‡ªåŠ¨æ”¶é›† |
| å•†æˆ·è¶…é™æŠ±æ€¨ | ä¸­ | ä¸­ | æå‰é€šçŸ¥,è‡ªåŠ©ç”³è¯·æé¢ |
| æ–°æ¸ é“ç¨³å®šæ€§ | ä¸­ | ä¸­ | ç°åº¦å‘å¸ƒ,æµé‡æ§åˆ¶ |

---

## ğŸ“… é‡Œç¨‹ç¢‘

- âœ… **Week 2**: åŸºç¡€è®¾æ–½å°±ç»ª
- âœ… **Week 5**: æ ¸å¿ƒåŠŸèƒ½å®Œæˆ (å¯¹è´¦+æ‹’ä»˜+é¢åº¦)
- âœ… **Week 8**: æ¸ é“é›†æˆå®Œæˆ (4å¤§æ¸ é“)
- âœ… **Week 10**: è¶…æ—¶å¤„ç†+ç¾å¤‡éƒ¨ç½²
- âœ… **Week 11**: æµ‹è¯•å®Œæˆ
- ğŸ¯ **Week 12**: æ­£å¼ä¸Šçº¿

---

## ğŸ“ è”ç³»æ–¹å¼

**é¡¹ç›®è´Ÿè´£äºº**: [æ‚¨çš„åå­—]
**æŠ€æœ¯æ”¯æŒ**: development@payment-platform.com
**ç´§æ€¥è”ç³»**: [ç”µè¯å·ç ]

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-25
**å®¡æ ¸çŠ¶æ€**: å¾…å®¡æ ¸

---

> **ä¸‹ä¸€æ­¥è¡ŒåŠ¨**:
> 1. å›¢é˜Ÿè¯„å®¡æœ¬è®¡åˆ’
> 2. ç¡®è®¤èµ„æºåˆ†é…
> 3. å¯åŠ¨Sprint 1
> 4. æ¯å‘¨è¿›åº¦åŒæ­¥ä¼šè®®
