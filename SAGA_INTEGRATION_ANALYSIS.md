# Saga åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆåˆ†ææŠ¥å‘Š

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æäº†æ”¯ä»˜å¹³å°ä¸­å“ªäº›ä¸šåŠ¡æµç¨‹éœ€è¦ä½¿ç”¨ Saga åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼ï¼Œä»¥åŠå½“å‰çš„å®ç°çŠ¶æ€å’Œæ”¹è¿›å»ºè®®ã€‚

## å½“å‰çŠ¶æ€

### âœ… å·²é›†æˆ Saga çš„æœåŠ¡

#### 1. Payment Gateway (æ”¯ä»˜ç½‘å…³)
**æ–‡ä»¶**: `backend/services/payment-gateway/internal/service/saga_payment_service.go`

**å·²å®ç°çš„ Saga æµç¨‹**:
- **æ”¯ä»˜åˆ›å»ºæµç¨‹** (`ExecutePaymentSaga`):
  ```
  æ­¥éª¤1: CreateOrder (åˆ›å»ºè®¢å•)
    â†“
  æ­¥éª¤2: CallPaymentChannel (è°ƒç”¨æ”¯ä»˜æ¸ é“)
  ```

**è¡¥å¿é€»è¾‘**:
- CreateOrder å¤±è´¥ â†’ æ— éœ€è¡¥å¿
- CallPaymentChannel å¤±è´¥ â†’ å–æ¶ˆè®¢å• (`compensateCreateOrder`)

**çŠ¶æ€**: âœ… å·²å®ç°å¹¶å¢å¼ºï¼ˆè¶…æ—¶30s/60sï¼Œé‡è¯•3æ¬¡ï¼‰

---

## éœ€è¦é›†æˆ Saga çš„å…³é”®ä¸šåŠ¡æµç¨‹

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¼ºçƒˆæ¨èï¼‰

#### 1. é€€æ¬¾æµç¨‹ (Refund Process)
**æœåŠ¡**: Payment Gateway
**æ–‡ä»¶**: `backend/services/payment-gateway/internal/service/payment_service.go`

**å½“å‰å®ç°**: æ™®é€šäº‹åŠ¡ï¼ˆé Sagaï¼‰

**æ¶‰åŠæ­¥éª¤**:
1. éªŒè¯é€€æ¬¾æ¡ä»¶ï¼ˆé‡‘é¢ã€çŠ¶æ€ï¼‰
2. è°ƒç”¨ Channel Adapter å‘èµ·æ¸ é“é€€æ¬¾
3. æ›´æ–°æ”¯ä»˜è®°å½•çŠ¶æ€
4. è°ƒç”¨ Accounting Service é€€æ¬¾è®°è´¦
5. å‘å¸ƒé€€æ¬¾äº‹ä»¶

**ä¸ºä»€ä¹ˆéœ€è¦ Saga**:
- âŒ **é—®é¢˜**: æ¸ é“é€€æ¬¾æˆåŠŸä½†è®°è´¦å¤±è´¥ â†’ èµ„é‡‘ä¸ä¸€è‡´
- âŒ **é—®é¢˜**: æ¸ é“é€€æ¬¾å¤±è´¥ä½†æ•°æ®åº“å·²æ›´æ–° â†’ çŠ¶æ€ä¸ä¸€è‡´
- âœ… **è§£å†³**: ä½¿ç”¨ Saga ä¿è¯é€€æ¬¾æµç¨‹çš„æœ€ç»ˆä¸€è‡´æ€§

**æ¨è Saga æ­¥éª¤è®¾è®¡**:
```go
æ­¥éª¤1: ValidateRefund (éªŒè¯é€€æ¬¾æ¡ä»¶)
  è¡¥å¿: æ— éœ€è¡¥å¿

æ­¥éª¤2: CallChannelRefund (è°ƒç”¨æ¸ é“é€€æ¬¾)
  è¡¥å¿: å¦‚æœåç»­å¤±è´¥ï¼Œéœ€è¦è°ƒç”¨æ¸ é“å–æ¶ˆé€€æ¬¾ï¼ˆéƒ¨åˆ†æ¸ é“æ”¯æŒï¼‰

æ­¥éª¤3: UpdatePaymentStatus (æ›´æ–°æ”¯ä»˜çŠ¶æ€)
  è¡¥å¿: æ¢å¤åŸçŠ¶æ€

æ­¥éª¤4: RecordAccounting (è®°è´¦)
  è¡¥å¿: å†²æ­£è®°è´¦è®°å½•

æ­¥éª¤5: PublishRefundEvent (å‘å¸ƒäº‹ä»¶)
  è¡¥å¿: æ— éœ€è¡¥å¿ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰
```

**ä¼˜å…ˆçº§**: ğŸ”´ **HIGH** - æ¶‰åŠèµ„é‡‘å®‰å…¨

---

#### 2. ç»“ç®—æ‰§è¡Œæµç¨‹ (Settlement Execution)
**æœåŠ¡**: Settlement Service
**æ–‡ä»¶**: `backend/services/settlement-service/internal/service/settlement_service.go`
**æ–¹æ³•**: `ExecuteSettlement`

**å½“å‰å®ç°**: éƒ¨åˆ†äº‹åŠ¡ä¿æŠ¤ï¼Œä½†è·¨æœåŠ¡è°ƒç”¨æ— äº‹åŠ¡ä¿è¯

**æ¶‰åŠæ­¥éª¤**:
1. æ›´æ–°ç»“ç®—å•çŠ¶æ€ä¸º Processing
2. ä» Merchant Service è·å–å•†æˆ·é“¶è¡Œè´¦æˆ·
3. è°ƒç”¨ Withdrawal Service åˆ›å»ºæç°
4. ç­‰å¾…æç°å®Œæˆ
5. æ›´æ–°ç»“ç®—å•çŠ¶æ€ä¸º Completed/Failed

**ä¸ºä»€ä¹ˆéœ€è¦ Saga**:
- âŒ **é—®é¢˜**: æç°åˆ›å»ºæˆåŠŸä½†ç»“ç®—å•çŠ¶æ€æœªæ›´æ–°
- âŒ **é—®é¢˜**: è·å–è´¦æˆ·å¤±è´¥ä½†ç»“ç®—å•å·²æ ‡è®° Processing
- âŒ **é—®é¢˜**: æç°å¤±è´¥éœ€è¦å›æ»šç»“ç®—å•çŠ¶æ€
- âœ… **è§£å†³**: ä½¿ç”¨ Saga åè°ƒè·¨æœåŠ¡çš„ç»“ç®—æµç¨‹

**æ¨è Saga æ­¥éª¤è®¾è®¡**:
```go
æ­¥éª¤1: ValidateSettlement (éªŒè¯ç»“ç®—å•)
  è¡¥å¿: æ— éœ€è¡¥å¿

æ­¥éª¤2: GetMerchantAccount (è·å–å•†æˆ·è´¦æˆ·)
  è¡¥å¿: æ— éœ€è¡¥å¿

æ­¥éª¤3: CreateWithdrawal (åˆ›å»ºæç°)
  è¡¥å¿: å–æ¶ˆæç°

æ­¥éª¤4: WaitWithdrawalComplete (ç­‰å¾…æç°å®Œæˆ)
  è¡¥å¿: å¦‚æœåç»­å¤±è´¥ï¼Œå›æ»šæç°çŠ¶æ€

æ­¥éª¤5: UpdateSettlementStatus (æ›´æ–°ç»“ç®—çŠ¶æ€)
  è¡¥å¿: æ¢å¤åŸçŠ¶æ€
```

**ä¼˜å…ˆçº§**: ğŸ”´ **HIGH** - æ¶‰åŠè‡ªåŠ¨ç»“ç®—å’Œæç°

---

#### 3. æç°æ‰§è¡Œæµç¨‹ (Withdrawal Execution)
**æœåŠ¡**: Withdrawal Service
**æ–‡ä»¶**: `backend/services/withdrawal-service/internal/service/withdrawal_service.go`
**æ–¹æ³•**: `ExecuteWithdrawal` (è¡Œ342-429)

**å½“å‰å®ç°**: é¡ºåºè°ƒç”¨ï¼Œæœ‰æ³¨é‡Šæåˆ°éœ€è¦å›æ»šä½†æœªå®ç°

**æ¶‰åŠæ­¥éª¤**:
1. æ›´æ–°æç°çŠ¶æ€ä¸º Processing
2. è°ƒç”¨ Bank Transfer Client å‘èµ·é“¶è¡Œè½¬è´¦
3. è°ƒç”¨ Accounting Service æ‰£å‡å•†æˆ·ä½™é¢
4. æ›´æ–°æç°çŠ¶æ€ä¸º Completed

**ä¸ºä»€ä¹ˆéœ€è¦ Saga**:
- âŒ **é—®é¢˜**: é“¶è¡Œè½¬è´¦æˆåŠŸä½†ä½™é¢æ‰£å‡å¤±è´¥ â†’ èµ„é‡‘æŸå¤±
- âŒ **é—®é¢˜**: ä½™é¢æ‰£å‡æˆåŠŸä½†è½¬è´¦å¤±è´¥ â†’ å•†æˆ·æŸå¤±
- âš ï¸ **ä»£ç ä¸­çš„æ³¨é‡Š**: "ä½™é¢æ‰£å‡å¤±è´¥ï¼Œéœ€è¦å›æ»šé“¶è¡Œè½¬è´¦ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦å®ç°ï¼‰"
- âœ… **è§£å†³**: ä½¿ç”¨ Saga ä¿è¯æç°æµç¨‹çš„ä¸€è‡´æ€§

**æ¨è Saga æ­¥éª¤è®¾è®¡**:
```go
æ­¥éª¤1: ValidateWithdrawal (éªŒè¯æç°)
  è¡¥å¿: æ— éœ€è¡¥å¿

æ­¥éª¤2: PreFreezeBalance (é¢„å†»ç»“ä½™é¢)
  è¡¥å¿: è§£å†»ä½™é¢

æ­¥éª¤3: ExecuteBankTransfer (æ‰§è¡Œé“¶è¡Œè½¬è´¦)
  è¡¥å¿: è°ƒç”¨é“¶è¡Œé€€æ¬¾æ¥å£ï¼ˆå¦‚æ”¯æŒï¼‰
  è¶…æ—¶: 120ç§’ï¼ˆé“¶è¡Œæ¥å£å¯èƒ½è¾ƒæ…¢ï¼‰

æ­¥éª¤4: DeductBalance (æ‰£å‡ä½™é¢)
  è¡¥å¿: é€€è¿˜ä½™é¢

æ­¥éª¤5: UpdateWithdrawalStatus (æ›´æ–°çŠ¶æ€)
  è¡¥å¿: æ¢å¤åŸçŠ¶æ€
```

**ä¼˜å…ˆçº§**: ğŸ”´ **HIGH** - æ¶‰åŠèµ„é‡‘è½¬è´¦ï¼Œå·²æœ‰ä»£ç æ³¨é‡Šæ ‡è¯†éœ€è¦å®ç°

---

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å®ç°ï¼‰

#### 4. æ”¯ä»˜å›è°ƒå¤„ç†æµç¨‹ (Payment Callback)
**æœåŠ¡**: Payment Gateway
**æ–‡ä»¶**: `backend/services/payment-gateway/internal/service/payment_service.go`
**æ–¹æ³•**: `HandleCallback`

**å½“å‰å®ç°**: é¡ºåºè°ƒç”¨å¤šä¸ªæœåŠ¡

**æ¶‰åŠæ­¥éª¤**:
1. è®°å½•å›è°ƒæ•°æ®
2. éªŒè¯ç­¾å
3. æŸ¥è¯¢æ”¯ä»˜è®°å½•
4. æ›´æ–°æ”¯ä»˜çŠ¶æ€
5. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆè°ƒç”¨ Order Serviceï¼‰
6. å‘å¸ƒæ”¯ä»˜æˆåŠŸäº‹ä»¶
7. è°ƒç”¨ Accounting Service è®°è´¦
8. è°ƒç”¨ Analytics Service ç»Ÿè®¡

**ä¸ºä»€ä¹ˆéœ€è¦ Saga**:
- âš ï¸ **é—®é¢˜**: è®¢å•çŠ¶æ€æ›´æ–°å¤±è´¥ä½†æ”¯ä»˜å·²æ ‡è®°æˆåŠŸ
- âš ï¸ **é—®é¢˜**: è®°è´¦å¤±è´¥ä½†çŠ¶æ€å·²æ›´æ–°
- âœ… **è§£å†³**: ä½¿ç”¨ Saga ä¿è¯å›è°ƒå¤„ç†çš„å®Œæ•´æ€§

**æ¨è Saga æ­¥éª¤è®¾è®¡**:
```go
æ­¥éª¤1: RecordCallback (è®°å½•å›è°ƒ)
  è¡¥å¿: æ— éœ€è¡¥å¿ï¼ˆå·²è®°å½•ï¼‰

æ­¥éª¤2: UpdatePaymentStatus (æ›´æ–°æ”¯ä»˜çŠ¶æ€)
  è¡¥å¿: æ¢å¤åŸçŠ¶æ€

æ­¥éª¤3: UpdateOrderStatus (æ›´æ–°è®¢å•çŠ¶æ€)
  è¡¥å¿: æ¢å¤è®¢å•çŠ¶æ€

æ­¥éª¤4: RecordAccounting (è®°è´¦)
  è¡¥å¿: å†²æ­£è®°è´¦

æ­¥éª¤5: PublishEvent (å‘å¸ƒäº‹ä»¶)
  è¡¥å¿: æ— éœ€è¡¥å¿ï¼ˆå¼‚æ­¥ï¼‰
```

**ä¼˜å…ˆçº§**: ğŸŸ¡ **MEDIUM** - æ¶‰åŠæ”¯ä»˜æˆåŠŸæµç¨‹ï¼Œä½†æœ‰å¹‚ç­‰æ€§ä¿æŠ¤

---

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰å®ç°ï¼‰

#### 5. å•†æˆ·å…¥é©»æµç¨‹ (Merchant Onboarding)
**æœåŠ¡**: Merchant Service
**æ¶‰åŠ**: åˆ›å»ºå•†æˆ· â†’ åˆ›å»ºç»“ç®—è´¦æˆ· â†’ åˆ›å»º API Key â†’ å‘é€æ¬¢è¿é€šçŸ¥

**å½“å‰å®ç°**: å¯èƒ½ä½¿ç”¨æ™®é€šäº‹åŠ¡

**æ˜¯å¦éœ€è¦ Saga**: å¯é€‰
- éèµ„é‡‘ç›¸å…³
- å¤±è´¥å½±å“è¾ƒå°
- å¯ä»¥ä½¿ç”¨äº‹ä»¶é©±åŠ¨ + äººå·¥ä»‹å…¥

---

#### 6. KYC å®¡æ ¸æµç¨‹ (KYC Verification)
**æœåŠ¡**: KYC Service
**æ¶‰åŠ**: æäº¤èµ„æ–™ â†’ å®¡æ ¸ â†’ æ›´æ–°å•†æˆ·çŠ¶æ€ â†’ é€šçŸ¥

**æ˜¯å¦éœ€è¦ Saga**: å¯é€‰
- éå®æ—¶æµç¨‹
- å¯ä»¥ä½¿ç”¨çŠ¶æ€æœº + å¼‚æ­¥å¤„ç†

---

## é›†æˆä¼˜å…ˆçº§æ€»ç»“

### ğŸ”´ ç«‹å³å®æ–½ï¼ˆP0ï¼‰

| ä¸šåŠ¡æµç¨‹ | æœåŠ¡ | åŸå›  | é£é™©ç­‰çº§ |
|---------|------|------|---------|
| **æç°æ‰§è¡Œ** | Withdrawal Service | å·²æœ‰æ³¨é‡Šæ ‡è¯†éœ€è¦å®ç°ï¼Œæ¶‰åŠé“¶è¡Œè½¬è´¦ | ğŸ”´ HIGH |
| **é€€æ¬¾æµç¨‹** | Payment Gateway | æ¶‰åŠèµ„é‡‘é€€å›ï¼Œéœ€ä¿è¯ä¸€è‡´æ€§ | ğŸ”´ HIGH |

### ğŸŸ¡ è¿‘æœŸå®æ–½ï¼ˆP1ï¼‰

| ä¸šåŠ¡æµç¨‹ | æœåŠ¡ | åŸå›  | é£é™©ç­‰çº§ |
|---------|------|------|---------|
| **ç»“ç®—æ‰§è¡Œ** | Settlement Service | è‡ªåŠ¨ç»“ç®—æ¶‰åŠå¤šæœåŠ¡åè°ƒ | ğŸŸ¡ MEDIUM |
| **æ”¯ä»˜å›è°ƒ** | Payment Gateway | æ¶‰åŠå¤šæœåŠ¡çŠ¶æ€æ›´æ–° | ğŸŸ¡ MEDIUM |

### ğŸŸ¢ å¯é€‰å®æ–½ï¼ˆP2ï¼‰

| ä¸šåŠ¡æµç¨‹ | æœåŠ¡ | åŸå›  |
|---------|------|------|
| å•†æˆ·å…¥é©» | Merchant Service | éèµ„é‡‘æµç¨‹ï¼Œå¯å¼‚æ­¥å¤„ç† |
| KYC å®¡æ ¸ | KYC Service | é•¿æµç¨‹ï¼Œå¯çŠ¶æ€æœºå®ç° |

---

## å®æ–½å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼šæç°æ‰§è¡Œ Sagaï¼ˆ1-2å‘¨ï¼‰

**æ­¥éª¤**:
1. åˆ›å»º `withdrawal_saga_service.go`
2. å®ç° Saga æ­¥éª¤å’Œè¡¥å¿é€»è¾‘
3. é›†æˆåˆ° `ExecuteWithdrawal` æ–¹æ³•
4. å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. ç°åº¦å‘å¸ƒ

**ç¤ºä¾‹ä»£ç ç»“æ„**:
```go
// backend/services/withdrawal-service/internal/service/withdrawal_saga_service.go

type WithdrawalSagaService struct {
    orchestrator       *saga.SagaOrchestrator
    withdrawalRepo     repository.WithdrawalRepository
    accountingClient   *client.AccountingClient
    bankTransferClient *client.BankTransferClient
}

func (s *WithdrawalSagaService) ExecuteWithdrawalSaga(
    ctx context.Context,
    withdrawal *model.Withdrawal,
) error {
    sagaBuilder := s.orchestrator.NewSagaBuilder(
        withdrawal.WithdrawalNo,
        "withdrawal",
    )

    // æ­¥éª¤1: é¢„å†»ç»“ä½™é¢
    sagaBuilder.AddStepWithTimeout(
        "PreFreezeBalance",
        s.executePreFreezeBalance,
        s.compensatePreFreezeBalance,
        3,
        30*time.Second,
    )

    // æ­¥éª¤2: é“¶è¡Œè½¬è´¦
    sagaBuilder.AddStepWithTimeout(
        "ExecuteBankTransfer",
        s.executeBankTransfer,
        s.compensateBankTransfer,
        3,
        120*time.Second, // é“¶è¡Œæ¥å£è¾ƒæ…¢
    )

    // æ­¥éª¤3: æ‰£å‡ä½™é¢
    sagaBuilder.AddStepWithTimeout(
        "DeductBalance",
        s.executeDeductBalance,
        s.compensateDeductBalance,
        3,
        30*time.Second,
    )

    // æ‰§è¡Œ Saga
    sagaInstance, err := sagaBuilder.Build(ctx)
    if err != nil {
        return err
    }

    return s.orchestrator.Execute(ctx, sagaInstance, stepDefs)
}
```

---

### ç¬¬äºŒé˜¶æ®µï¼šé€€æ¬¾æµç¨‹ Sagaï¼ˆ1-2å‘¨ï¼‰

**æ­¥éª¤**:
1. åœ¨ Payment Gateway åˆ›å»º `refund_saga_service.go`
2. å®ç°é€€æ¬¾ Saga æµç¨‹
3. é›†æˆåˆ° `CreateRefund` æ–¹æ³•
4. å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. ç°åº¦å‘å¸ƒ

---

### ç¬¬ä¸‰é˜¶æ®µï¼šç»“ç®—å’Œå›è°ƒ Sagaï¼ˆ2-3å‘¨ï¼‰

**å¹¶è¡Œå®æ–½**:
- Settlement Service: ç»“ç®—æ‰§è¡Œ Saga
- Payment Gateway: æ”¯ä»˜å›è°ƒ Saga

---

## æŠ€æœ¯æ³¨æ„äº‹é¡¹

### 1. å¹‚ç­‰æ€§è®¾è®¡

æ‰€æœ‰ Saga æ­¥éª¤çš„æ‰§è¡Œå’Œè¡¥å¿æ“ä½œå¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼š

```go
// å¹‚ç­‰æ€§ç¤ºä¾‹
func (s *Service) executeDeductBalance(ctx context.Context, data string) (string, error) {
    // ä½¿ç”¨å¹‚ç­‰æ€§ Keyï¼ˆå·²åœ¨ saga.go ä¸­å®ç°ï¼‰
    // Redis ä¼šè‡ªåŠ¨æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œ

    // æ‰§è¡Œæ‰£æ¬¾...
    return result, nil
}
```

### 2. è¡¥å¿é€»è¾‘è®¾è®¡åŸåˆ™

1. **å¯å›æ»š**: æ¯ä¸ªæ­¥éª¤éƒ½è¦æœ‰å¯¹åº”çš„è¡¥å¿é€»è¾‘
2. **æœ€ç»ˆä¸€è‡´æ€§**: æ¥å—çŸ­æœŸä¸ä¸€è‡´ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´
3. **äººå·¥ä»‹å…¥**: æ— æ³•è‡ªåŠ¨è¡¥å¿çš„è¿›å…¥ DLQ
4. **ç›‘æ§å‘Šè­¦**: è¡¥å¿å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ç«‹å³å‘Šè­¦

### 3. è¶…æ—¶é…ç½®

æ ¹æ®ä¸åŒæ“ä½œç±»å‹è®¾ç½®åˆç†è¶…æ—¶ï¼š

| æ“ä½œç±»å‹ | æ¨èè¶…æ—¶ |
|---------|---------|
| æœ¬åœ°æ•°æ®åº“æ“ä½œ | 10ç§’ |
| å†…éƒ¨æœåŠ¡è°ƒç”¨ | 30ç§’ |
| é“¶è¡Œè½¬è´¦æ¥å£ | 120ç§’ |
| æ”¯ä»˜æ¸ é“æ¥å£ | 60ç§’ |

### 4. ç›‘æ§æŒ‡æ ‡

ä¸ºæ¯ä¸ªä¸šåŠ¡ Saga æ·»åŠ ç›‘æ§ï¼š

```promql
# æç° Saga æˆåŠŸç‡
sum(rate(saga_total{business_type="withdrawal",status="completed"}[5m]))
/ sum(rate(saga_total{business_type="withdrawal"}[5m]))

# æç°è¡¥å¿ç‡
sum(rate(saga_compensation_total{business_type="withdrawal"}[5m]))
/ sum(rate(saga_total{business_type="withdrawal"}[5m]))
```

---

## é£é™©è¯„ä¼°

### é«˜é£é™©åœºæ™¯

| åœºæ™¯ | é£é™© | ç¼“è§£æªæ–½ |
|------|------|---------|
| æç°è½¬è´¦æˆåŠŸä½†ä½™é¢æ‰£å‡å¤±è´¥ | ğŸ”´ èµ„é‡‘æŸå¤± | **å¿…é¡»ä½¿ç”¨ Saga** |
| é€€æ¬¾æˆåŠŸä½†æœªè®°è´¦ | ğŸ”´ è´¦åŠ¡ä¸å¹³ | **å¿…é¡»ä½¿ç”¨ Saga** |
| ç»“ç®—å¤±è´¥ä½†æç°å·²åˆ›å»º | ğŸŸ¡ çŠ¶æ€ä¸ä¸€è‡´ | ä½¿ç”¨ Saga + DLQ |
| å›è°ƒå¤„ç†å¤±è´¥ | ğŸŸ¡ è®¢å•çŠ¶æ€é”™è¯¯ | å¹‚ç­‰æ€§ + é‡è¯• |

### å®æ–½é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| Saga é€»è¾‘ Bug | ä¸­ | é«˜ | å……åˆ†æµ‹è¯• + ç°åº¦å‘å¸ƒ |
| Redis æ•…éšœå½±å“é”å’Œå¹‚ç­‰æ€§ | ä½ | é«˜ | Redis é«˜å¯ç”¨éƒ¨ç½² |
| DLQ å †ç§¯ | ä¸­ | ä¸­ | ç›‘æ§å‘Šè­¦ + äººå·¥å¤„ç†æµç¨‹ |
| æ€§èƒ½ä¸‹é™ | ä½ | ä½ | å‹åŠ›æµ‹è¯• + ä¼˜åŒ– |

---

## æŠ•å…¥ä¸æ”¶ç›Š

### æŠ•å…¥ä¼°ç®—

| é˜¶æ®µ | å·¥ä½œé‡ | äººåŠ› |
|------|--------|------|
| æç° Saga | 1-2å‘¨ | 1äºº |
| é€€æ¬¾ Saga | 1-2å‘¨ | 1äºº |
| ç»“ç®— + å›è°ƒ Saga | 2-3å‘¨ | 1-2äºº |
| æµ‹è¯• + æ–‡æ¡£ | 1å‘¨ | 1äºº |
| **æ€»è®¡** | **5-8å‘¨** | **1-2äºº** |

### æ”¶ç›Š

| ç»´åº¦ | æ”¶ç›Š |
|------|------|
| **èµ„é‡‘å®‰å…¨** | âœ… æ¶ˆé™¤æç°å’Œé€€æ¬¾çš„èµ„é‡‘é£é™© |
| **æ•°æ®ä¸€è‡´æ€§** | âœ… ä¿è¯è·¨æœåŠ¡çš„æœ€ç»ˆä¸€è‡´æ€§ |
| **ç³»ç»Ÿç¨³å®šæ€§** | âœ… è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼Œå‡å°‘äººå·¥ä»‹å…¥ |
| **å¯è§‚æµ‹æ€§** | âœ… å®Œæ•´çš„ç›‘æ§æŒ‡æ ‡å’Œæ—¥å¿— |
| **åˆè§„æ€§** | âœ… æ»¡è¶³é‡‘èç³»ç»Ÿä¸€è‡´æ€§è¦æ±‚ |

---

## ç»“è®º

### å½“å‰çŠ¶æ€
- âœ… **Payment Gateway**: æ”¯ä»˜åˆ›å»ºå·²ä½¿ç”¨ Saga å¹¶å¢å¼º
- âŒ **Withdrawal Service**: æç°æ‰§è¡Œéœ€è¦ Sagaï¼ˆä»£ç æ³¨é‡Šå·²æ ‡è¯†ï¼‰
- âŒ **Payment Gateway**: é€€æ¬¾æµç¨‹éœ€è¦ Saga
- âŒ **Settlement Service**: ç»“ç®—æ‰§è¡Œéœ€è¦ Saga

### æ¨èè¡ŒåŠ¨
1. **ç«‹å³å®æ–½**: æç°æ‰§è¡Œå’Œé€€æ¬¾æµç¨‹ Sagaï¼ˆP0ï¼‰
2. **è¿‘æœŸå®æ–½**: ç»“ç®—æ‰§è¡Œå’Œæ”¯ä»˜å›è°ƒ Sagaï¼ˆP1ï¼‰
3. **æŒç»­ç›‘æ§**: ä½¿ç”¨ Recovery Worker + DLQ å¤„ç†å¤±è´¥åœºæ™¯
4. **é€æ­¥ä¼˜åŒ–**: æ ¹æ®ç›‘æ§æ•°æ®è°ƒæ•´è¶…æ—¶å’Œé‡è¯•ç­–ç•¥

### é¢„æœŸç»“æœ
- ğŸ¯ æ¶ˆé™¤èµ„é‡‘é£é™©åœºæ™¯
- ğŸ¯ æå‡ç³»ç»Ÿå¯é æ€§è‡³ 99.9%+
- ğŸ¯ è‡ªåŠ¨å¤„ç† 95%+ çš„è¡¥å¿åœºæ™¯
- ğŸ¯ DLQ äººå·¥ä»‹å…¥ç‡ < 1%

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-10-24
**ä½œè€…**: Claude Code
**ç›¸å…³æ–‡æ¡£**:
- [SAGA_COMPENSATION_ENHANCEMENTS.md](SAGA_COMPENSATION_ENHANCEMENTS.md)
- [SAGA_ENHANCEMENTS_SUMMARY.md](SAGA_ENHANCEMENTS_SUMMARY.md)
