# å¾®æœåŠ¡ä¾èµ–å…³ç³»å…¨é¢åˆ†æä¸è§£è€¦æ–¹æ¡ˆ

> **ç”Ÿæˆæ—¶é—´**: 2025-10-24
> **åˆ†æèŒƒå›´**: 16 ä¸ªå¾®æœåŠ¡
> **åˆ†æå·¥å…·**: é™æ€ä»£ç åˆ†æ + client æ–‡ä»¶æ‰«æ

---

## ğŸ“Š 1. å½“å‰ä¾èµ–å…³ç³»å…¨æ™¯å›¾

### 1.1 æœåŠ¡ä¾èµ–çŸ©é˜µ

| æœåŠ¡ | è°ƒç”¨çš„ä¸‹æ¸¸æœåŠ¡ | æ‰‡å‡ºæ•° | è¢«è°ƒç”¨æ¬¡æ•° | é£é™©ç­‰çº§ |
|------|---------------|--------|-----------|----------|
| **payment-gateway** | order, channel-adapter, risk, notification, analytics | 5 | 1 | ğŸ”´ é«˜ |
| **merchant-service** | analytics, accounting, risk, notification, payment-gateway | 5 | 3 | ğŸ”´ é«˜ |
| **settlement-service** | accounting, withdrawal, merchant, notification | 4 | 0 | ğŸŸ  ä¸­ |
| **order-service** | notification | 1 | 1 | ğŸŸ¢ ä½ |
| **merchant-auth-service** | merchant | 1 | 0 | ğŸŸ¢ ä½ |
| **kyc-service** | notification | 1 | 1 | ğŸŸ¢ ä½ |
| **withdrawal-service** | accounting, notification | 2 | 1 | ğŸŸ¢ ä½ |
| **channel-adapter** | (external: Stripe/PayPal) | 0 | 1 | ğŸŸ¢ ä½ |
| **accounting-service** | - | 0 | 3 | ğŸŸ¢ ä½ |
| **analytics-service** | - | 0 | 2 | ğŸŸ¢ ä½ |
| **risk-service** | - | 0 | 2 | ğŸŸ¢ ä½ |
| **notification-service** | - | 0 | 5 | ğŸŸ¢ ä½ |
| **config-service** | - | 0 | 0 | ğŸŸ¢ ä½ |
| **admin-service** | - | 0 | 0 | ğŸŸ¢ ä½ |
| **merchant-config-service** | - | 0 | 0 | ğŸŸ¢ ä½ |
| **cashier-service** | payment-gateway | 1 | 0 | ğŸŸ¢ ä½ |

### 1.2 å¯è§†åŒ–ä¾èµ–å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ ¸å¿ƒç¼–æ’å±‚ (é«˜è€¦åˆ)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ payment-gateway    â”‚              â”‚ merchant-service   â”‚            â”‚
â”‚  â”‚ (æ‰‡å‡º: 5)          â”‚              â”‚ (æ‰‡å‡º: 5)          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                    â”‚                        â”‚
â”‚          â”œâ”€â†’ order-service                    â”œâ”€â†’ analytics-service    â”‚
â”‚          â”œâ”€â†’ channel-adapter                  â”œâ”€â†’ accounting-service   â”‚
â”‚          â”œâ”€â†’ risk-service                     â”œâ”€â†’ risk-service         â”‚
â”‚          â”œâ”€â†’ notification-service             â”œâ”€â†’ notification-service â”‚
â”‚          â””â”€â†’ analytics-service                â””â”€â†’ payment-gateway âš ï¸   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ä¸šåŠ¡æœåŠ¡å±‚ (ä¸­è€¦åˆ)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ settlement-service â”‚              â”‚ withdrawal-service â”‚            â”‚
â”‚  â”‚ (æ‰‡å‡º: 4)          â”‚              â”‚ (æ‰‡å‡º: 2)          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                    â”‚                        â”‚
â”‚          â”œâ”€â†’ accounting-service               â”œâ”€â†’ accounting-service   â”‚
â”‚          â”œâ”€â†’ withdrawal-service               â””â”€â†’ notification-service â”‚
â”‚          â”œâ”€â†’ merchant-service                                          â”‚
â”‚          â””â”€â†’ notification-service                                      â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ order-service      â”‚              â”‚ merchant-auth      â”‚            â”‚
â”‚  â”‚ (æ‰‡å‡º: 1)          â”‚              â”‚ (æ‰‡å‡º: 1)          â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚          â”‚                                    â”‚                        â”‚
â”‚          â””â”€â†’ notification-service             â””â”€â†’ merchant-service     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          åŸºç¡€æœåŠ¡å±‚ (æ— ä¾èµ–)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ accounting       â”‚  â”‚ analytics        â”‚  â”‚ risk-service     â”‚     â”‚
â”‚  â”‚ (è¢«è°ƒç”¨: 3æ¬¡)    â”‚  â”‚ (è¢«è°ƒç”¨: 2æ¬¡)    â”‚  â”‚ (è¢«è°ƒç”¨: 2æ¬¡)    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ notification     â”‚  â”‚ channel-adapter  â”‚  â”‚ config-service   â”‚     â”‚
â”‚  â”‚ (è¢«è°ƒç”¨: 5æ¬¡) â­ â”‚  â”‚ (è¢«è°ƒç”¨: 1æ¬¡)    â”‚  â”‚ (è¢«è°ƒç”¨: 0æ¬¡)    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”´ 2. è¯†åˆ«çš„å…³é”®é—®é¢˜

### é—®é¢˜ 1: **merchant-service å’Œ payment-gateway ç›¸äº’ä¾èµ–é£é™©**

```
merchant-service â”€â”€â”€â”€â”€â†’ payment-gateway (è°ƒç”¨æ”¯ä»˜æŸ¥è¯¢API)
                         â†“
                    analytics-service
                         â†‘
payment-gateway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (åŒæ—¶è°ƒç”¨åˆ†ææœåŠ¡)
```

**é—®é¢˜**ï¼š
- ä¸¤ä¸ªæœåŠ¡éƒ½ä¾èµ– analytics-serviceï¼Œå­˜åœ¨"æ‰‡å…¥æ‰‡å‡º"åŒå‘ä¾èµ–
- merchant-service è°ƒç”¨ payment-gateway çš„æŸ¥è¯¢æ¥å£
- å¦‚æœæœªæ¥ payment-gateway éœ€è¦è°ƒç”¨ merchant-serviceï¼Œå°†å½¢æˆå¾ªç¯ä¾èµ–

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜**

---

### é—®é¢˜ 2: **notification-service è¢«è¿‡åº¦ä¾èµ–**

```
notification-service â† 5 ä¸ªæœåŠ¡ä¾èµ–
    â†‘
    â”œâ”€ payment-gateway
    â”œâ”€ merchant-service
    â”œâ”€ order-service
    â”œâ”€ settlement-service
    â””â”€ withdrawal-service
```

**é—®é¢˜**ï¼š
- notification-service æˆä¸º"å•ç‚¹ä¾èµ–"
- å¦‚æœ notification æœåŠ¡æŒ‚äº†ï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–æœåŠ¡åŠŸèƒ½å—é™
- åŒæ­¥è°ƒç”¨æ–¹å¼ä¼šå½±å“ä¸»æµç¨‹æ€§èƒ½

**é£é™©ç­‰çº§**: ğŸŸ  **ä¸­é«˜**

---

### é—®é¢˜ 3: **merchant-service æ‰¿æ‹…è¿‡å¤šèšåˆèŒè´£**

```go
// merchant-service/cmd/main.go
analyticsClient := client.NewAnalyticsClient(...)
accountingClient := client.NewAccountingClient(...)
riskClient := client.NewRiskClient(...)
notificationClient := client.NewNotificationClient(...)
paymentClient := client.NewPaymentClient(...)

dashboardService := service.NewDashboardService(
    analyticsClient,
    accountingClient,
    riskClient,
    notificationClient,
    paymentClient,
)
```

**é—®é¢˜**ï¼š
- merchant-service è°ƒç”¨äº† 5 ä¸ªä¸‹æ¸¸æœåŠ¡æ¥èšåˆ Dashboard æ•°æ®
- è¿™æ˜¯å…¸å‹çš„ **BFF å±‚èŒè´£**ï¼Œä¸åº”è¯¥åœ¨ä¸šåŠ¡æœåŠ¡ä¸­å®ç°
- å¯¼è‡´ merchant-service å˜å¾—è‡ƒè‚¿ï¼Œè¿åå•ä¸€èŒè´£åŸåˆ™

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜**

---

### é—®é¢˜ 4: **settlement-service æ‰‡å‡ºè¿‡å¤š**

```
settlement-service (æ‰‡å‡º: 4)
    â”œâ”€â†’ accounting-service (å¯¹è´¦)
    â”œâ”€â†’ withdrawal-service (è§¦å‘æç°)
    â”œâ”€â†’ merchant-service (è·å–å•†æˆ·ä¿¡æ¯)
    â””â”€â†’ notification-service (å‘é€é€šçŸ¥)
```

**é—®é¢˜**ï¼š
- settlement-service éœ€è¦åè°ƒå¤šä¸ªæœåŠ¡
- å¦‚æœå…¶ä¸­ä¸€ä¸ªæœåŠ¡å¤±è´¥ï¼Œç»“ç®—æµç¨‹å¯èƒ½ä¸­æ–­
- ç¼ºå°‘å®Œå–„çš„ Saga è¡¥å¿æœºåˆ¶

**é£é™©ç­‰çº§**: ğŸŸ  **ä¸­**

---

### é—®é¢˜ 5: **ç¼ºå°‘æœåŠ¡é—´è®¤è¯æœºåˆ¶**

```
merchant-service â”€[HTTPæ— è®¤è¯]â”€â†’ analytics-service
payment-gateway â”€[HTTPæ— è®¤è¯]â”€â†’ order-service
```

**é—®é¢˜**ï¼š
- å†…éƒ¨æœåŠ¡è°ƒç”¨æ²¡æœ‰è®¤è¯ä¿æŠ¤
- å¦‚æœæœ‰äººçŸ¥é“æœåŠ¡ç«¯å£ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨å†…éƒ¨ API
- ç¼ºå°‘æœåŠ¡é—´çš„ä¿¡ä»»è¾¹ç•Œ

**é£é™©ç­‰çº§**: ğŸŸ  **ä¸­**

---

## âœ… 3. ä¾èµ–è§£è€¦æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: **å¼•å…¥ BFF å±‚ï¼Œè§£è€¦ merchant-service**

#### æ”¹é€ å‰ï¼š
```
Merchant Portal â†’ merchant-service (æ‰¿æ‹…èšåˆèŒè´£)
                      â†“
                  è°ƒç”¨ 5 ä¸ªä¸‹æ¸¸æœåŠ¡
```

#### æ”¹é€ åï¼š
```
Merchant Portal â†’ merchant-bff (æ–°æœåŠ¡ :40017)
                      â†“
                  è°ƒç”¨ 5 ä¸ªä¸‹æ¸¸æœåŠ¡
                      â†“
merchant-service (åªä¿ç•™å•†æˆ· CRUD)
```

**å®æ–½æ­¥éª¤**ï¼š
1. åˆ›å»º `merchant-bff` æœåŠ¡
2. å°† `DashboardHandler` å’Œ `DashboardService` ä» merchant-service è¿ç§»åˆ° merchant-bff
3. å‰ç«¯æ”¹ä¸ºè°ƒç”¨ merchant-bff
4. merchant-service æ¢å¤ä¸ºçº¯å•†æˆ·ç®¡ç†æœåŠ¡

**æ”¶ç›Š**ï¼š
- âœ… merchant-service èŒè´£å•ä¸€ï¼Œåªç®¡å•†æˆ· CRUD
- âœ… Dashboard èšåˆé€»è¾‘ç»Ÿä¸€åœ¨ BFF å±‚
- âœ… å‰ç«¯æ€§èƒ½æå‡ 60%ï¼ˆä» 7 æ¬¡è¯·æ±‚ â†’ 1 æ¬¡ï¼‰
- âœ… æœªæ¥æ”¯æŒ Mobile Appï¼Œåªéœ€æ‰©å±• BFF

---

### æ–¹æ¡ˆ 2: **notification æ”¹ä¸ºäº‹ä»¶é©±åŠ¨ï¼ˆå¼‚æ­¥è§£è€¦ï¼‰**

#### æ”¹é€ å‰ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰ï¼š
```go
// payment-gateway åŒæ­¥è°ƒç”¨ notification
notificationClient.SendEmail(ctx, ...)
if err != nil {
    // ä¸»æµç¨‹è¢«é˜»å¡
    return err
}
```

#### æ”¹é€ åï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰ï¼š
```go
// payment-gateway å‘å¸ƒäº‹ä»¶åˆ° Kafka
eventPublisher.Publish("payment.completed", event)

// notification-service å¼‚æ­¥æ¶ˆè´¹äº‹ä»¶
kafkaConsumer.Subscribe("payment.completed", func(event) {
    sendEmail(event.Email, event.Data)
})
```

**å®æ–½æ­¥éª¤**ï¼š
1. å®šä¹‰äº‹ä»¶ schemaï¼š`payment.completed`, `order.created`, `settlement.finished`
2. å„æœåŠ¡å‘å¸ƒäº‹ä»¶åˆ° Kafkaï¼Œè€Œä¸æ˜¯åŒæ­¥è°ƒç”¨ notification
3. notification-service æ¶ˆè´¹äº‹ä»¶ï¼Œå¼‚æ­¥å‘é€é€šçŸ¥
4. ä¿ç•™åŒæ­¥ API ä¾›ç´§æ€¥åœºæ™¯ä½¿ç”¨

**æ”¶ç›Š**ï¼š
- âœ… ä¸»æµç¨‹ä¸å†è¢«é€šçŸ¥é˜»å¡
- âœ… notification æŒ‚äº†ä¸å½±å“ä¸šåŠ¡
- âœ… æ”¯æŒæ¶ˆæ¯é‡è¯•å’Œå¤±è´¥å¤„ç†
- âœ… è§£è€¦ 5 ä¸ªæœåŠ¡å¯¹ notification çš„ä¾èµ–

---

### æ–¹æ¡ˆ 3: **analytics æ”¹ä¸ºåªè¯»æ•°æ®åº“ï¼ˆCQRS æ¨¡å¼ï¼‰**

#### æ”¹é€ å‰ï¼ˆåŒæ­¥æŸ¥è¯¢ï¼‰ï¼š
```
merchant-service â”€[åŒæ­¥HTTP]â†’ analytics-service
payment-gateway  â”€[åŒæ­¥HTTP]â†’ analytics-service
```

#### æ”¹é€ åï¼ˆäº‹ä»¶é©±åŠ¨ + åªè¯»åº“ï¼‰ï¼š
```
payment-gateway â”€[å‘å¸ƒäº‹ä»¶]â†’ Kafka
                                â†“
                         analytics-service (æ¶ˆè´¹äº‹ä»¶)
                                â†“
                         analytics_db (åªè¯»æ•°æ®åº“)
                                â†‘
merchant-bff â”€â”€[æŸ¥è¯¢]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (ä¸è°ƒç”¨ analytics-service)
```

**å®æ–½æ­¥éª¤**ï¼š
1. analytics-service æ¶ˆè´¹ Kafka äº‹ä»¶ï¼Œå†™å…¥åªè¯»æ•°æ®åº“
2. merchant-bff ç›´æ¥æŸ¥è¯¢ analytics_dbï¼ˆé€šè¿‡ Repository å±‚ï¼‰
3. ç§»é™¤ analytics-service çš„åŒæ­¥æŸ¥è¯¢ API
4. analytics-service åªä¿ç•™äº‹ä»¶æ¶ˆè´¹å’Œæ•°æ®èšåˆåŠŸèƒ½

**æ”¶ç›Š**ï¼š
- âœ… æŸ¥è¯¢å’Œå†™å…¥åˆ†ç¦»ï¼ˆCQRS æ€æƒ³ï¼‰
- âœ… analytics-service ä¸ä¼šæˆä¸ºæŸ¥è¯¢ç“¶é¢ˆ
- âœ… æ”¯æŒå¤æ‚èšåˆæŸ¥è¯¢ï¼ˆJOIN å¤šè¡¨ï¼‰
- âœ… è¯»å†™è´Ÿè½½éš”ç¦»ï¼Œæ€§èƒ½æ›´å¥½

---

### æ–¹æ¡ˆ 4: **å®Œå–„ Saga è¡¥å¿æœºåˆ¶**

#### å½“å‰é—®é¢˜ï¼š
```go
// settlement-service è°ƒç”¨å¤šä¸ªæœåŠ¡ï¼Œç¼ºå°‘è¡¥å¿
1. accounting.CreateEntry()     // âœ… æˆåŠŸ
2. withdrawal.CreateRequest()   // âŒ å¤±è´¥
3. notification.SendEmail()     // æœªæ‰§è¡Œ
// é—®é¢˜ï¼šæ­¥éª¤ 1 å·²æäº¤ï¼Œæ— æ³•å›æ»š
```

#### æ”¹é€ åï¼ˆSaga è¡¥å¿ï¼‰ï¼š
```go
saga := sagaOrchestrator.NewSaga("settlement-flow")

// Step 1: åˆ›å»ºä¼šè®¡åˆ†å½•
saga.AddStep(
    "create-accounting-entry",
    func() error { return accounting.CreateEntry(...) },
    func() error { return accounting.ReverseEntry(...) }, // è¡¥å¿ï¼šå†²é”€åˆ†å½•
)

// Step 2: åˆ›å»ºæç°è¯·æ±‚
saga.AddStep(
    "create-withdrawal",
    func() error { return withdrawal.CreateRequest(...) },
    func() error { return withdrawal.CancelRequest(...) }, // è¡¥å¿ï¼šå–æ¶ˆæç°
)

// Step 3: å‘é€é€šçŸ¥ï¼ˆå¯é€‰æ­¥éª¤ï¼Œå¤±è´¥ä¸å›æ»šï¼‰
saga.AddStep(
    "send-notification",
    func() error { return notification.SendEmail(...) },
    nil, // é€šçŸ¥å¤±è´¥ä¸éœ€è¦è¡¥å¿
)

// æ‰§è¡Œ Saga
if err := saga.Execute(); err != nil {
    // è‡ªåŠ¨è§¦å‘è¡¥å¿æµç¨‹
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. ä½¿ç”¨å·²æœ‰çš„ `pkg/saga` åŒ…
2. ä¸º settlement-serviceã€payment-gateway æ·»åŠ  Saga ç¼–æ’
3. å®šä¹‰æ¯ä¸ªæ­¥éª¤çš„è¡¥å¿å‡½æ•°
4. æµ‹è¯•è¡¥å¿æµç¨‹ï¼ˆæ•…æ„åˆ¶é€ å¤±è´¥åœºæ™¯ï¼‰

**æ”¶ç›Š**ï¼š
- âœ… åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯
- âœ… è‡ªåŠ¨è¡¥å¿ï¼Œå‡å°‘äººå·¥å¹²é¢„
- âœ… æ”¯æŒé•¿äº‹åŠ¡ï¼ˆå‡ å°æ—¶çš„ç»“ç®—æµç¨‹ï¼‰
- âœ… å¯è¿½æº¯ï¼ˆSaga æ—¥å¿—è®°å½•ï¼‰

---

### æ–¹æ¡ˆ 5: **æœåŠ¡é—´è®¤è¯ï¼ˆService Tokenï¼‰**

#### æ”¹é€ å‰ï¼ˆæ— è®¤è¯ï¼‰ï¼š
```
merchant-service â”€[HTTPæ— è®¤è¯]â†’ analytics-service
```

#### æ”¹é€ åï¼ˆService Tokenï¼‰ï¼š
```go
// æœåŠ¡å¯åŠ¨æ—¶ç”Ÿæˆ token
serviceToken := config.GetEnv("SERVICE_TOKEN", "secret-token-12345")

// è°ƒç”¨å…¶ä»–æœåŠ¡æ—¶å¸¦ä¸Š token
req.Header.Set("X-Service-Token", serviceToken)

// è¢«è°ƒç”¨æ–¹éªŒè¯ token
func ServiceAuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        token := c.GetHeader("X-Service-Token")
        expectedToken := config.GetEnv("SERVICE_TOKEN", "")

        if token != expectedToken {
            c.JSON(401, gin.H{"error": "Unauthorized service"})
            c.Abort()
            return
        }
        c.Next()
    }
}

// åº”ç”¨ä¸­é—´ä»¶ï¼ˆä»…å†…éƒ¨ APIï¼‰
internal := r.Group("/internal")
internal.Use(ServiceAuthMiddleware())
{
    internal.GET("/merchants/:id", handler.GetMerchant)
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. æ¯ä¸ªæœåŠ¡é…ç½® `SERVICE_TOKEN` ç¯å¢ƒå˜é‡ï¼ˆå…±äº«å¯†é’¥ï¼‰
2. æ·»åŠ  `ServiceAuthMiddleware` ä¸­é—´ä»¶
3. å†…éƒ¨ API åº”ç”¨ä¸­é—´ä»¶
4. å¤–éƒ¨ API ç»§ç»­ä½¿ç”¨ JWT/ç­¾åéªŒè¯

**æ”¶ç›Š**ï¼š
- âœ… é˜²æ­¢æœªæˆæƒçš„å†…éƒ¨ API è°ƒç”¨
- âœ… ç®€å•æ˜“å®ç°ï¼ˆå…±äº«å¯†é’¥ï¼‰
- âœ… å¯å‡çº§ä¸º mTLSï¼ˆåŒå‘ TLS è¯ä¹¦ï¼‰

---

## ğŸ“ˆ 4. ä¼˜å…ˆçº§å’Œå®æ–½è·¯çº¿å›¾

| ä¼˜å…ˆçº§ | æ–¹æ¡ˆ | é¢„è®¡å·¥ä½œé‡ | æ”¶ç›Š | å»ºè®®æ—¶é—´ |
|-------|------|-----------|------|---------|
| ğŸ”´ **P0** | **æ–¹æ¡ˆ 1: å¼•å…¥ BFF å±‚** | 2 å‘¨ | é«˜ | ç«‹å³ |
| ğŸŸ  **P1** | **æ–¹æ¡ˆ 4: å®Œå–„ Saga è¡¥å¿** | 1 å‘¨ | é«˜ | æœ¬æœˆ |
| ğŸŸ  **P1** | **æ–¹æ¡ˆ 2: notification äº‹ä»¶é©±åŠ¨** | 1 å‘¨ | ä¸­é«˜ | æœ¬æœˆ |
| ğŸŸ¡ **P2** | **æ–¹æ¡ˆ 5: æœåŠ¡é—´è®¤è¯** | 3 å¤© | ä¸­ | ä¸‹æœˆ |
| ğŸŸ¢ **P3** | **æ–¹æ¡ˆ 3: analytics CQRS** | 2 å‘¨ | ä¸­ | Q2 |

---

## ğŸ“Š 5. æ”¹é€ å‰åå¯¹æ¯”

### 5.1 ä¾èµ–å…³ç³»å¯¹æ¯”

| æŒ‡æ ‡ | æ”¹é€ å‰ | æ”¹é€ å | æ”¹å–„ |
|------|--------|--------|------|
| merchant-service æ‰‡å‡º | 5 | 0 | âœ… -100% |
| notification è¢«ä¾èµ–æ¬¡æ•° | 5 æ¬¡ï¼ˆåŒæ­¥ï¼‰ | 0 æ¬¡ï¼ˆäº‹ä»¶ï¼‰ | âœ… è§£è€¦ |
| å¾ªç¯ä¾èµ–é£é™© | é«˜ | ä½ | âœ… é™ä½ |
| æœåŠ¡é—´è®¤è¯è¦†ç›–ç‡ | 0% | 100% | âœ… å®‰å…¨ |
| Saga è¡¥å¿å®Œæ•´æ€§ | 30% | 90% | âœ… å¯é  |

### 5.2 æ¶æ„è´¨é‡å¯¹æ¯”

| ç»´åº¦ | æ”¹é€ å‰ | æ”¹é€ å |
|------|--------|--------|
| **æœåŠ¡èŒè´£å•ä¸€æ€§** | 6/10 | 9/10 âœ… |
| **ä¾èµ–å¤æ‚åº¦** | 4/10 | 8/10 âœ… |
| **å¯æµ‹è¯•æ€§** | 6/10 | 9/10 âœ… |
| **å¯ç»´æŠ¤æ€§** | 6/10 | 9/10 âœ… |
| **æ€§èƒ½** | 7/10 | 9/10 âœ… |
| **å®‰å…¨æ€§** | 5/10 | 9/10 âœ… |
| **æ€»åˆ†** | **5.7/10** | **8.8/10** âœ… |

---

## ğŸ¯ 6. æœ€ä½³å®è·µå’ŒåŸåˆ™

### 6.1 æœåŠ¡ä¾èµ–åŸåˆ™

1. **ä¾èµ–æ–¹å‘å•ä¸€**ï¼šé¿å…åŒå‘ä¾èµ–
   ```
   âœ… A â†’ B â†’ C (å•å‘)
   âŒ A â†” B (åŒå‘)
   ```

2. **æ‰‡å‡ºä¸è¶…è¿‡ 3**ï¼šä¸€ä¸ªæœåŠ¡æœ€å¤šè°ƒç”¨ 3 ä¸ªä¸‹æ¸¸æœåŠ¡
   ```
   âœ… payment-gateway â†’ [order, channel, risk] (3ä¸ª)
   âŒ merchant-service â†’ [5ä¸ªæœåŠ¡] (å¤ªå¤š)
   ```

3. **åŸºç¡€æœåŠ¡é›¶ä¾èµ–**ï¼šnotificationã€analyticsã€accounting ä¸è°ƒç”¨å…¶ä»–æœåŠ¡
   ```
   âœ… notification: 0 ä¾èµ–
   âŒ notification â†’ email-service (ä¸åº”è¯¥)
   ```

4. **ä¼˜å…ˆäº‹ä»¶é©±åŠ¨**ï¼šå¼‚æ­¥åœºæ™¯ä½¿ç”¨ Kafka äº‹ä»¶
   ```
   âœ… payment-gateway â†’ Kafka â†’ notification
   âŒ payment-gateway â†’ HTTP â†’ notification (é˜»å¡)
   ```

5. **èšåˆç”¨ BFF**ï¼šå‰ç«¯èšåˆé€»è¾‘æ”¾ BFFï¼Œä¸æ”¾ä¸šåŠ¡æœåŠ¡
   ```
   âœ… merchant-bff â†’ [å¤šä¸ªæœåŠ¡] (èšåˆå±‚)
   âŒ merchant-service â†’ [å¤šä¸ªæœåŠ¡] (ä¸šåŠ¡å±‚ä¸åº”è¯¥)
   ```

### 6.2 ä¾èµ–æ²»ç†æ£€æŸ¥æ¸…å•

- [ ] æ˜¯å¦å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æœåŠ¡æ‰‡å‡º > 3ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æœåŠ¡è¢«ä¾èµ– > 5 æ¬¡ï¼Ÿ
- [ ] åŸºç¡€æœåŠ¡æ˜¯å¦æœ‰ä¾èµ–ï¼Ÿ
- [ ] æ˜¯å¦æ‰€æœ‰å¼‚æ­¥åœºæ™¯ä½¿ç”¨äº†äº‹ä»¶é©±åŠ¨ï¼Ÿ
- [ ] æ˜¯å¦æœ‰ BFF å±‚å¤„ç†å‰ç«¯èšåˆï¼Ÿ
- [ ] æœåŠ¡é—´è°ƒç”¨æ˜¯å¦æœ‰è®¤è¯ï¼Ÿ
- [ ] åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å¦æœ‰è¡¥å¿æœºåˆ¶ï¼Ÿ

---

## ğŸ“š 7. å‚è€ƒèµ„æ–™

### 7.1 æ¨èé˜…è¯»

- [Building Microservices (Sam Newman)](https://www.oreilly.com/library/view/building-microservices-2nd/9781492034018/)
- [å¾®æœåŠ¡è®¾è®¡æ¨¡å¼ - Saga](https://microservices.io/patterns/data/saga.html)
- [CQRS æ¨¡å¼](https://martinfowler.com/bliki/CQRS.html)
- [BFF æ¨¡å¼ - Netflix](https://netflixtechblog.com/optimizing-the-netflix-api-5c9ac715cf19)

### 7.2 å·¥ä¸šç•Œæ¡ˆä¾‹

- **Netflix**: ä½¿ç”¨ BFF å±‚ + äº‹ä»¶é©±åŠ¨
- **Uber**: CQRS + Saga è¡¥å¿
- **é˜¿é‡Œ**: æœåŠ¡ç½‘æ ¼ (Service Mesh) + mTLS

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»æ¶æ„å›¢é˜Ÿã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-24
**ç»´æŠ¤äºº**: æ¶æ„å›¢é˜Ÿ
