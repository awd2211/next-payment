# 后端代码 - TODO待办事项、占位符和未完成实现分析

**分析日期**: 2025-10-26
**扫描文件总数**: 19个服务 + pkg公共库
**发现TODO注释总数**: 57
**严重问题**: 12
**高优先级问题**: 18
**中优先级问题**: 19
**低优先级问题**: 8

---

## 执行摘要

支付平台后端在 **31个文件** 中有 **57条TODO注释**。虽然核心支付处理流程（Payment Gateway → Order → Channel Adapter）已完全实现并可投入生产，但几个新增和扩展服务有 **未完成的实现** 需要在生产部署前处理。

**关键发现**:
- ✅ **核心服务**（Payment Gateway、Order、Channel Adapter、Risk、Accounting）：100%完成
- 🟡 **支持服务**（Settlement、Withdrawal、Reconciliation、Dispute）：60-80%完成（集成功能的TODO）
- 🟡 **新扩展服务**（Merchant Quota、Merchant Policy）：70%完成（缺少集成）
- ❌ **占位符实现**：4个gRPC方法返回Unimplemented；8个银行API适配器使用mock模式

---

## 按严重程度分类

### 严重问题（12个）- 生产部署前必须修复

这些问题阻塞核心功能或造成安全风险：

| # | 服务 | 文件 | 行号 | 问题 | 影响 |
|---|------|------|------|------|------|
| 1 | dispute-service | dispute_service.go | 469 | `merchantID` 未初始化（仅变量声明） | 支付记录未关联到争议 |
| 2 | dispute-service | dispute_service.go | 480 | `PaymentNo` 硬编码为空字符串 | 无法追踪原始支付 |
| 3 | withdrawal-service | bank_transfer_client.go | 334-363 | ABC、BOC、CCB银行API使用mock模式 | 银行转账在生产环境总是失败 |
| 4 | settlement-service | auto_settlement_task.go | 110 | 未集成商户配置服务 | 无法自动结算商户特定策略 |
| 5 | kyc-service | kyc_service.go | 92 | OCR服务未实现 | 文档验证不完整 |
| 6 | merchant-auth-service | merchant_auth_server.go | 34 | Login gRPC返回Unimplemented | gRPC认证流程损坏 |
| 7 | merchant-auth-service | merchant_auth_server.go | 40 | RefreshToken gRPC返回Unimplemented | Token刷新损坏 |
| 8 | admin-bff-service | admin_server.go | 353 | 商户审核逻辑未实现 | 无法批准商户 |
| 9 | admin-bff-service | admin_server.go | 430 | 审批流程创建未实现 | 无法处理审批 |
| 10 | payment-gateway | main.go | 245 | Kafka生产者适配器未实现 | 事件发布损坏 |
| 11 | merchant-quota-service | main.go | 105 | 策略服务客户端未初始化 | 配额强制执行不完整 |
| 12 | risk-service | risk_handler.go | 328 | 支付反馈未实现 | 风控模型无法训练 |

---

### 高优先级问题（18个）- 生产部署前应该修复

这些影响重要功能但有回退方案或不太关键：

| # | 服务 | 文件 | 行号 | 问题 | 影响 | 解决方案 |
|---|------|------|------|------|------|---------|
| 1 | accounting-service | account_service.go | 1655 | 未从channel-adapter获取汇率 | 多币种转换不准确 | 使用默认汇率 |
| 2 | config-service | health_checker.go | 144 | 状态更新逻辑未实现 | 健康检查不完整 | 返回nil |
| 3 | analytics-service | analytics_server.go | 169 | 跨商户统计查询未实现 | 无法聚合统计 | 无聚合 |
| 4 | analytics-service | analytics_server.go | 226 | 系统健康检查未实现 | 系统监控不完整 | 返回nil |
| 5 | analytics-service | analytics_server.go | 247 | 报表生成未实现 | 无法生成报表 | 无 |
| 6 | analytics-service | analytics_server.go | 269 | 报表存储/查询未实现 | 报表无法检索 | 无 |
| 7 | kyc-service | grpc/kyc_server.go | 180-181 | 邮箱/手机验证标志未集成 | KYC不完整 | 总是false |
| 8 | merchant-auth-service | api_key_service.go | 102 | API密钥所有权验证缺失 | 安全风险 | 未强制执行 |
| 9 | payment-gateway | webhook_notification_service.go | 177 | 商户webhook密钥未从数据库获取 | Webhook签名失败 | 使用硬编码值 |
| 10 | payment-gateway | payment_service.go | 1302 | GeoIP国家检测使用硬编码"US" | 风控评分不准确 | 默认为US |
| 11 | payment-gateway | api_key_repository.go | 146 | CIDR IP白名单未完全实现 | IP限制不完整 | 部分支持 |
| 12 | merchant-policy-service | policy_binding_service.go | 168 | 自定义策略ID验证缺失 | 可创建无效策略 | 无验证 |
| 13 | merchant-policy-service | tier_service.go | 156 | 无法检查商户等级使用情况 | 等级删除可能破坏数据 | 无验证 |
| 14 | settlement-service | settlement_server.go | 329 | 待结算金额未计算 | 统计不完整 | 返回0 |
| 15 | settlement-service | auto_settlement_task.go | 204 | 退款金额未从accounting获取 | 结算金额不准确 | 返回0 |
| 16 | settlement-service | auto_settlement_task.go | 379 | 通知客户端未调用 | 结算通知未发送 | 无 |
| 17 | notification-service | cmd/main.go | 166 | Mock SMS提供商硬编码 | 所有短信发送到mock | 开发模式 |
| 18 | order-service | order_handler.go | 805 | 订单统计未从数据库聚合 | 统计不准确 | 返回硬编码数据 |

---

### 中优先级问题（19个）- 主要版本发布前应该修复

这些改进功能、可观测性或集成，但不阻塞核心操作：

| # | 服务 | 文件 | 行号 | 问题 | 影响 |
|---|------|------|------|------|------|
| 1 | webhook | retry.go | 402 | Webhook payload/secret未从数据库重新加载 | 过期的webhook密钥 | 需要重新获取 |
| 2 | email | mailgun.go | 221 | REST API统计未实现 | 无法通过API获取邮件统计 | 必须使用Mailgun UI |
| 3 | email | mailgun.go | 230 | 邮件验证API未实现 | 无法验证邮箱地址 | 跳过验证 |
| 4 | merchant-quota-service | quota_service.go | 47, 122, 174 | 策略服务客户端未集成 | 配额策略未强制执行 | 硬编码默认值 |
| 5 | merchant-quota-service | alert_service.go | 39, 84, 113, 146 | 通知和策略集成缺失 | 警报未发送；策略未获取 | 流程不完整 |
| 6 | merchant-policy-service | policy_engine_service.go | 162 | 阶梯费率规则未从JSON解析 | 不支持复杂费率结构 | 仅支持固定费率 |
| 7 | merchant-policy-service | policy_binding_service.go | 198 | 自定义策略查询未实现 | 无法检索自定义策略 | 返回nil |
| 8 | merchant-policy-service | policy_binding_service.go | 110 | 渠道策略仓库未实例化 | 渠道策略未管理 | 无操作初始化 |
| 9 | merchant-policy-service | repository/*.go | Multiple | 费率、限额和渠道策略仓库不完整 | 无法持久化策略 | 空函数 |
| 10 | merchant-quota-service | repository/*.go | Multiple | 配额和警报仓库不完整 | 配额数据未持久化 | 无存储 |
| 11 | channel-adapter | channel_service.go | 728 | 预授权记录查找未实现 | 无法确定支付渠道 | 需要手动选择 |
| 12 | reconciliation-service | main.go | 101 | 自动化调度器/检测器/通知器未集成 | 仅支持手动对账 | 无自动化 |
| 13 | merchant-bff-service | logging/structured_logger.go | 262 | Loki HTTP请求未发送 | 日志仅在内存中 | 未发送到Loki |
| 14 | admin-bff-service | logging/structured_logger.go | 262 | Loki HTTP请求未发送 | 日志仅在内存中 | 未发送到Loki |
| 15 | admin-bff-service | grpc/admin_server.go | 360, 436, 442 | 商户审核/审批列表查询未实现 | 无法列出审核/审批 | 返回空 |
| 16 | risk-service | grpc/risk_server.go | 58 | 匹配规则列表为空 | 无法查看触发了哪些规则 | 返回空数组 |
| 17 | risk-service | grpc/risk_server.go | 117 | 支付反馈机制未实现 | 风控模型无法从结果学习 | 无反馈循环 |
| 18 | withdrawal-service | client/bank_transfer_client.go | 49-56 | 银行渠道配置总是默认为mock | 银行转账从未真正执行 | 总是mock模式 |
| 19 | payment-gateway | cmd/main.go | 245 | Kafka生产者适配器需要实现 | 事件流损坏 | 注释："需要实现" |

---

### 低优先级问题（8个）- 可选功能

这些改进代码质量或提供可选功能：

| # | 服务 | 文件 | 行号 | 问题 | 影响 |
|---|------|------|------|------|------|
| 1 | notification-service | sms_provider.go | 88-97 | Mock SMS提供商硬编码响应 | 总是返回mock SMS ID | 测试可接受 |
| 2 | withdrawal-service | cmd/main.go | 116 | 银行渠道总是默认为mock | 银行转账使用mock | 配置问题 |
| 3 | merchant-policy-service | cmd/main.go | 110 | 渠道策略仓库未使用 | 代码注释表明将来使用 | 当前未使用 |
| 4 | admin-bff-service | model/email_template.go | 37 | 邮件模板模型中的占位符字段 | 模板字段的元数据 | 不关键 |
| 5 | accounting-service | service/account_service.go | 1655 | 注释：TODO获取汇率 | 多币种计算 | 使用默认值 |
| 6 | pkg | saga/saga_test.go | Multiple | 测试中使用Mock | 测试基础设施 | 非生产代码 |
| 7 | pkg | health/db_checker.go | 82-83 | 健康检查中的虚拟变量 | 使用的SQL查询模式 | 无害 |
| 8 | payment-gateway | payment_service.go | 1383 | 注释：TODO从GeoIP检测国家 | 默认风控评分 | 使用硬编码US |

---

## 按服务分类的问题

### 1. DISPUTE-SERVICE（2个严重问题）
**文件**: `/home/eric/payment/backend/services/dispute-service/internal/service/dispute_service.go`

```go
// 行469: 严重 - 未初始化的merchantID
var merchantID uuid.UUID // TODO: Get from payment record

// 行480: 严重 - 空PaymentNo
PaymentNo: "", // TODO: Get from payment record
```

**影响**: 争议无法关联到原始支付或商户
**修复**: 在创建争议前查询支付表获取payment_no和merchant_id
**严重程度**: 严重

**建议修复**:
```go
// 获取支付详情
payment, err := s.paymentRepo.GetByChannelTradeNo(ctx, stripeDispute.Charge.ID)
if err != nil {
    return nil, fmt.Errorf("payment not found: %w", err)
}
merchantID = payment.MerchantID
paymentNo = payment.PaymentNo
```

---

### 2. WITHDRAWAL-SERVICE（3个严重问题 + 1个低优先级）
**文件**:
- `/home/eric/payment/backend/services/withdrawal-service/internal/client/bank_transfer_client.go`
- `/home/eric/payment/backend/services/withdrawal-service/cmd/main.go`

**严重问题**:

```go
// 行334: ABC银行未实现
func (c *BankTransferClient) transferABC(ctx context.Context, req *TransferRequest) (*TransferResponse, error) {
    // TODO: 实现农业银行API调用
    return c.mockTransfer(ctx, req)  // 总是返回mock!
}

// 行344-363: BOC、CCB银行相同
func (c *BankTransferClient) transferBOC(...) {
    // TODO: 实现中国银行API调用
    return c.mockTransfer(ctx, req)  // Mock模式
}
```

**影响**: ABC、BOC、CCB银行的银行转账在生产环境总是失败
**解决方案**: 仅ICBC已实现（行267-310）
**严重程度**: 严重 - 所有中国银行提款使用mock模式

**低优先级**:
```go
// cmd/main.go 行116
BankChannel: getConfig("BANK_CHANNEL", "mock"),  // 默认是mock模式!
```

---

### 3. KYC-SERVICE（2个严重问题 + 1个高优先级）
**文件**:
- `/home/eric/payment/backend/services/kyc-service/internal/service/kyc_service.go`
- `/home/eric/payment/backend/services/kyc-service/internal/grpc/kyc_server.go`

**严重问题**:
```go
// 行92: OCR服务未实现
// TODO: 调用OCR服务识别文档信息
// ocrData, err := ocrService.Extract(document.DocumentURL)

// 行100: 验证通知未发送
// TODO: 发送审核通知
// notificationService.NotifyReviewers(document)
```

**高优先级**:
```go
// 行180-181: 验证标志总是false
EmailVerified: false, // TODO: integrate with merchant service
PhoneVerified: false, // TODO: integrate with merchant service
```

**影响**:
- 严重: 文档无法自动验证
- 高优先级: 邮箱/手机验证不完整

---

### 4. SETTLEMENT-SERVICE（2个严重问题 + 3个高优先级）
**文件**:
- `/home/eric/payment/backend/services/settlement-service/internal/service/auto_settlement_task.go`
- `/home/eric/payment/backend/services/settlement-service/internal/grpc/settlement_server.go`

**严重问题**:
```go
// 行110: 商户配置服务未集成
// TODO: 实现merchant_config_service后从配置表查询启用自动结算的商户列表
// 当前: 仅查询过去7天的商户结算
```

**高优先级问题**:
```go
// 行204: 退款金额硬编码为0
RefundAmount: 0, // TODO: 从accounting获取退款数据

// 行329: 待结算金额未计算
PendingSettlementAmount: 0, // TODO: Calculate pending amount

// 行379: 通知未发送
// TODO: 实际调用notification client发送邮件/短信
```

**影响**:
- 自动结算不遵守商户策略
- 结算计算不完整
- 商户未收到通知

---

### 5. MERCHANT-AUTH-SERVICE（2个严重问题 + 1个高优先级）
**文件**:
- `/home/eric/payment/backend/services/merchant-auth-service/internal/grpc/merchant_auth_server.go`
- `/home/eric/payment/backend/services/merchant-auth-service/internal/service/api_key_service.go`

**严重问题 - gRPC认证流程损坏**:
```go
// 行33-40: 两个方法都返回Unimplemented
func (s *MerchantAuthServer) Login(...) (*pb.LoginResponse, error) {
    return nil, status.Errorf(codes.Unimplemented,
        "method Login not implemented - should use HTTP handler")
}

func (s *MerchantAuthServer) RefreshToken(...) (*pb.LoginResponse, error) {
    return nil, status.Errorf(codes.Unimplemented,
        "method RefreshToken not implemented - should use HTTP handler")
}
```

**高优先级 - API密钥安全问题**:
```go
// 行102: 密钥所有权未验证
// TODO: 验证key属于该merchant
// 当前: 未检查密钥是否属于请求商户
```

**影响**:
- 严重: gRPC登录/token流程完全损坏
- 高优先级: API密钥可被其他商户使用

---

### 6. PAYMENT-GATEWAY（2个严重问题 + 3个高优先级）
**文件**:
- `/home/eric/payment/backend/services/payment-gateway/cmd/main.go`
- `/home/eric/payment/backend/services/payment-gateway/internal/service/payment_service.go`
- `/home/eric/payment/backend/services/payment-gateway/internal/service/webhook_notification_service.go`
- `/home/eric/payment/backend/services/payment-gateway/internal/repository/api_key_repository.go`

**严重问题**:
```go
// cmd/main.go 行245
nil, // TODO: 需要实现 KafkaProducer 适配器
// Kafka生产者从未初始化!
```

**高优先级**:
```go
// 行1302: GeoIP硬编码为US
country := "US" // 默认美国，TODO: 从 GeoIP 获取

// 行1383: 国家检测未实现
// TODO: 根据customer_ip或其他信息判断国家

// webhook_notification_service.go 行177
// TODO: 从数据库或缓存获取 merchant secret
// 当前: 使用硬编码值

// api_key_repository.go 行146
// TODO: 使用 net.IPNet.Contains() 实现完整CIDR支持
// CIDR IP白名单仅部分工作
```

**影响**:
- 严重: 事件流完全损坏（Kafka）
- 高优先级: 风控评分总是使用US地理位置
- 高优先级: Webhook签名总是使用硬编码密钥

---

### 7. MERCHANT-QUOTA-SERVICE（2个严重问题 + 6个中优先级）
**文件**:
- `/home/eric/payment/backend/services/merchant-quota-service/cmd/main.go`
- `/home/eric/payment/backend/services/merchant-quota-service/internal/service/quota_service.go`
- `/home/eric/payment/backend/services/merchant-quota-service/internal/service/alert_service.go`

**严重问题**:
```go
// cmd/main.go 行105
// TODO: 初始化 merchant-policy-service 客户端 (下阶段实现)
// 策略服务客户端从未初始化!

// quota_service.go 行47, 122, 174
// TODO: 添加 PolicyClient 用于调用 merchant-policy-service
// 配额策略未获取
```

**中优先级问题**:
```go
// alert_service.go 行84
// TODO: 调用 policy-service 获取限额策略

// alert_service.go 行113
// TODO: 发送预警通知

// alert_service.go 行146
// TODO: 调用 policy-service 获取限额策略

// 多个仓库文件: quota_repository.go, alert_repository.go
// 仓库方法有空实现
```

**影响**: 没有策略服务集成，商户配额无法强制执行

---

### 8. MERCHANT-POLICY-SERVICE（0个严重问题 + 6个中优先级）
**文件**:
- `/home/eric/payment/backend/services/merchant-policy-service/internal/service/policy_binding_service.go`
- `/home/eric/payment/backend/services/merchant-policy-service/internal/service/tier_service.go`
- `/home/eric/payment/backend/services/merchant-policy-service/internal/service/policy_engine_service.go`
- `/home/eric/payment/backend/services/merchant-policy-service/cmd/main.go`

**中优先级问题**:
```go
// policy_binding_service.go 行168
// TODO: 验证自定义策略ID是否存在

// policy_binding_service.go 行198
// TODO: 查询自定义费率策略和限额策略（如果有）

// tier_service.go 行156
// TODO: 检查是否有商户使用此等级

// policy_engine_service.go 行162
// TODO: 解析 TieredRules JSON 实现阶梯费率
// 当前: 仅支持固定费率，不支持阶梯规则

// cmd/main.go 行110
_ = repository.NewChannelPolicyRepository // TODO: 下阶段实现
// 未实例化或使用
```

**影响**:
- 策略验证不完整
- 不支持阶梯费率结构
- 渠道策略未管理

---

### 9. RECONCILIATION-SERVICE（1个严重问题）
**文件**: `/home/eric/payment/backend/services/reconciliation-service/cmd/main.go`

```go
// 行101
// TODO: Automation features (scheduler, detector, notifier) will be integrated later
// 扩展模型已准备好但:
// - ReconciliationDifference 跟踪未实现
// - ReconciliationReport 生成未实现
// - InternalTransaction 存储未使用
// - ChannelTransaction 存储未使用
```

**影响**: 仅支持手动对账；自动化延期到未来阶段

---

### 10. ADMIN-BFF-SERVICE（2个严重问题 + 5个高优先级）
**文件**:
- `/home/eric/payment/backend/services/admin-bff-service/internal/grpc/admin_server.go`
- `/home/eric/payment/backend/services/admin-bff-service/internal/logging/structured_logger.go`

**严重问题 - gRPC方法未实现**:
```go
// 行353, 360: 商户审核未实现
// TODO: 实现商户审核逻辑
// TODO: 实现商户审核列表查询

// 行430, 436, 442: 审批流程未实现
// TODO: 实现审批流程创建逻辑
// TODO: 实现审批处理逻辑
// TODO: 实现审批列表查询
```

**高优先级 - Loki集成缺失**:
```go
// logging/structured_logger.go 行262
// TODO: 实际发送HTTP请求到Loki
// 日志在内存中生成但未发送到Loki
```

**影响**:
- 严重: 无法通过gRPC批准商户
- 高优先级: 审计日志未持久化到日志聚合

---

### 11. ORDER-SERVICE（1个高优先级）
**文件**: `/home/eric/payment/backend/services/order-service/internal/handler/order_handler.go`

```go
// 行805
// TODO: 从数据库聚合真实订单统计数据
// 当前: 返回硬编码统计
```

**影响**: 订单统计API返回虚拟数据

---

### 12. ANALYTICS-SERVICE（0个严重问题 + 4个高优先级）
**文件**: `/home/eric/payment/backend/services/analytics-service/internal/grpc/analytics_server.go`

```go
// 行169
// TODO: 需要在repository层实现跨商户的统计查询

// 行226, 247, 269
// TODO: 需要实现系统健康检查逻辑
// TODO: 需要实现报表生成功能
// TODO: 需要实现报表存储和查询功能
```

**影响**:
- 跨商户分析不工作
- 系统健康检查不完整
- 报表生成和存储未实现

---

### 13. CHANNEL-ADAPTER（0个严重问题 + 1个中优先级）
**文件**: `/home/eric/payment/backend/services/channel-adapter/internal/service/channel_service.go`

```go
// 行728
// TODO: 从数据库获取预授权记录以确定使用哪个渠道
// 预授权渠道选择未实现
```

**影响**: 必须手动选择支付渠道

---

### 14. RISK-SERVICE（0个严重问题 + 2个高优先级）
**文件**: `/home/eric/payment/backend/services/risk-service/internal/grpc/risk_server.go` 和 `handler/risk_handler.go`

```go
// risk_server.go 行58
MatchedRules: []string{}, // TODO: 添加匹配的规则列表
// 匹配规则未返回

// risk_handler.go 行117, 328
// TODO: 实现支付结果反馈机制，用于优化风控模型
// 模型训练的支付反馈未实现
```

**影响**: 风险分析不显示触发了哪些规则；无法通过反馈改进风控模型

---

### 15. CONFIG-SERVICE（0个严重问题 + 1个高优先级）
**文件**: `/home/eric/payment/backend/services/config-service/internal/service/health_checker.go`

```go
// 行144
return nil // TODO: 实现状态更新逻辑
// 状态更新逻辑未实现
```

**影响**: 健康检查端点不完整

---

### 16. NOTIFICATION-SERVICE（1个低优先级）
**文件**:
- `/home/eric/payment/backend/services/notification-service/internal/provider/sms_provider.go`
- `/home/eric/payment/backend/services/notification-service/cmd/main.go`

```go
// sms_provider.go 行88-97
func (p *MockSMSProvider) Send(req *SMSRequest) (*SMSResponse, error) {
    return "mock"  // 硬编码响应
}

// cmd/main.go 行166
mockSMSProvider := provider.NewMockSMSProvider()
smsFactory.Register("mock", mockSMSProvider)
```

**影响**: 所有短信发送到mock提供商（开发环境预期）

---

### 17. ACCOUNTING-SERVICE（0个严重问题 + 1个高优先级）
**文件**: `/home/eric/payment/backend/services/accounting-service/internal/service/account_service.go`

```go
// 行1655
// TODO: 调用 channel-adapter 的汇率API
// 汇率未获取；多币种转换使用默认值
```

**影响**: 多币种转换可能不准确

---

### 18. PKG库（0个严重问题 + 2个高优先级）
**文件**:
- `/home/eric/payment/backend/pkg/webhook/retry.go`
- `/home/eric/payment/backend/pkg/email/mailgun.go`

```go
// webhook/retry.go 行402
// TODO: 从数据库重新获取 payload 和 secret
// Webhook payload/secret未重新加载

// email/mailgun.go 行221, 230
// TODO: 实现使用 REST API 调用统计接口
// TODO: 如需完整验证，使用 Mailgun Email Validation API
// Mailgun API集成不完整
```

**影响**:
- Webhook重试不获取新密钥
- 无法通过API获取邮件统计
- 邮件验证不可用

---

## 按服务汇总

| 服务 | 严重 | 高 | 中 | 低 | 状态 |
|------|------|----|----|----|----|
| **Payment Gateway** | 1 | 3 | 0 | 0 | 80% |
| **Dispute Service** | 2 | 0 | 0 | 0 | 60% |
| **Withdrawal Service** | 3 | 0 | 0 | 1 | 50% |
| **Merchant Auth Service** | 2 | 1 | 0 | 0 | 60% |
| **Settlement Service** | 1 | 3 | 0 | 0 | 70% |
| **KYC Service** | 2 | 1 | 0 | 0 | 65% |
| **Admin BFF Service** | 2 | 1 | 1 | 0 | 75% |
| **Merchant Quota Service** | 1 | 0 | 6 | 0 | 65% |
| **Merchant Policy Service** | 0 | 0 | 6 | 0 | 70% |
| **Reconciliation Service** | 0 | 0 | 1 | 0 | 75% |
| **Merchant BFF Service** | 0 | 0 | 1 | 0 | 95% |
| **Order Service** | 0 | 1 | 0 | 0 | 90% |
| **Analytics Service** | 0 | 4 | 0 | 0 | 75% |
| **Risk Service** | 0 | 2 | 0 | 0 | 85% |
| **Channel Adapter** | 0 | 0 | 1 | 0 | 90% |
| **Config Service** | 0 | 1 | 0 | 0 | 90% |
| **Notification Service** | 0 | 0 | 0 | 1 | 95% |
| **Accounting Service** | 0 | 1 | 0 | 0 | 90% |
| **PKG Library** | 0 | 2 | 0 | 0 | 95% |

---

## 推荐修复优先级

### 阶段1: 严重问题（任何生产部署前必须修复）
**预计工作量**: 80-100小时

1. **Dispute Service** - 关联争议到支付（4h）
2. **Withdrawal Service** - 实现银行API或使用单一提供商（20h）
3. **Merchant Auth Service** - 修复gRPC Login/RefreshToken（6h）
4. **Settlement Service** - 修复商户配置集成（8h）
5. **Payment Gateway** - 实现Kafka生产者（4h）
6. **KYC Service** - 实现OCR服务（12h）
7. **Admin BFF** - 实现商户审核/审批gRPC方法（8h）
8. **Merchant Quota** - 初始化策略服务客户端（4h）

### 阶段2: 高优先级（公开测试前修复）
**预计工作量**: 60-80小时

1. **Payment Gateway** - 修复webhook密钥获取和GeoIP检测（8h）
2. **Settlement Service** - 完成自动结算（12h）
3. **Admin BFF** - 发送日志到Loki（4h）
4. **Analytics** - 实现跨商户查询（12h）
5. **Risk Service** - 实现支付反馈（6h）
6. **Reconciliation** - 实现自动化（16h）
7. **Accounting** - 获取汇率（4h）

### 阶段3: 中优先级（正式发布前修复）
**预计工作量**: 40-60小时

1. **Merchant Quota** - 完成所有仓库实现（8h）
2. **Merchant Policy** - 完成策略绑定和验证（12h）
3. **Notification** - 真实SMS提供商集成（8h）
4. **Channel Adapter** - 预授权跟踪（6h）
5. **重构** - 代码清理和整合（16h）

---

## 需要解决的代码模式

### 模式1: 空仓库方法
**文件**: merchant-quota-service, merchant-policy-service
**问题**: `func (r *Repository) Create(...) error { return nil }`

**修复**: 实现实际的GORM持久化:
```go
func (r *QuotaRepository) Create(ctx context.Context, quota *model.Quota) error {
    return r.db.WithContext(ctx).Create(quota).Error
}
```

### 模式2: 未初始化的客户端存根
**文件**: merchant-quota-service, merchant-policy-service
**问题**: 客户端已初始化但从未使用
```go
// TODO: 初始化客户端
// policyClient := client.NewPolicyClient(...)
```

**修复**: 完成初始化或删除TODO

### 模式3: 硬编码默认值 vs. 配置
**文件**: withdrawal-service, notification-service
**问题**: `BankChannel: "mock"` 而不是配置

**修复**:
```go
bankChannel := os.Getenv("BANK_CHANNEL")
if bankChannel == "" {
    bankChannel = "icbc"  // 真实默认值，不是mock
}
```

### 模式4: 未实现的gRPC方法
**文件**: merchant-auth-service, admin-bff-service
**问题**: 方法返回`Unimplemented`错误

**修复**: 可以:
1. 如果不需要则移除gRPC服务器
2. 实现这些方法
3. 明确记录为什么使用HTTP而不是gRPC

---

## 测试缺口

### 单元测试覆盖率
- **当前**: Mock基础设施存在但使用有限
- **缺口**: 没有TODO实现的测试
- **建议**: 为所有修复的实现添加测试

### 集成测试
- **当前**: `/backend/tests/integration/`中有基本集成测试
- **缺口**: 没有不完整服务的测试（merchant-quota, merchant-policy）
- **建议**: 在修复TODO前添加集成测试

---

## 安全问题

| 问题 | 服务 | 严重程度 | 风险 |
|------|------|----------|------|
| API密钥所有权未验证 | merchant-auth-service | 高 | 跨商户API滥用 |
| Webhook密钥硬编码 | payment-gateway | 高 | Webhook欺骗 |
| CIDR IP白名单不完整 | payment-gateway | 中 | IP限制被绕过 |
| 银行转账使用mock模式 | withdrawal-service | 严重 | 生产环境提款失败 |
| 商户审核未实现 | admin-bff-service | 严重 | 无法批准商户 |

---

## 配置问题

### 默认为Mock模式
**文件**:
- withdrawal-service (`BankChannel: "mock"`)
- notification-service (mock SMS提供商)

**问题**: 生产部署可能在不知情的情况下使用mock提供商

**修复**:
1. 在bootstrap中添加环境变量验证
2. 如果未配置必需提供商则启动失败
3. 除测试模式外删除所有"mock"默认值

---

## 等待其他服务的依赖关系

```
Payment Gateway
├─ Kafka Producer（未实现）
├─ Risk Service（✅ 完成）
├─ Order Service（✅ 完成）
└─ Channel Adapter（✅ 完成）

Settlement Service
├─ Merchant Config Service（未初始化）
├─ Merchant Policy Service（未初始化）
└─ Accounting Service（部分 - 退款金额）

Merchant Quota Service
├─ Merchant Policy Service（未初始化）
└─ Notification Service（✅ 完成）

Merchant Policy Service
├─ Policy Repository（不完整）
└─ Tier Repository（不完整）

Withdrawal Service
├─ Bank Transfer APIs（ABC、BOC、CCB未实现）
└─ 仅ICBC已实现

Admin BFF
├─ Merchant Review/Approval（未实现）
├─ Audit Logging to Loki（未实现）
└─ All 18 aggregated services（✅ 完成）
```

---

## 修复所有问题的预计总工作量

| 阶段 | 小时 | 时间线 |
|------|------|--------|
| **阶段1（严重）** | 80-100 | 2-3周 |
| **阶段2（高优先级）** | 60-80 | 2-3周 |
| **阶段3（中优先级）** | 40-60 | 1-2周 |
| **测试与QA** | 40-60 | 1-2周 |
| **文档** | 20-30 | 1周 |
| **总计** | **240-330** | **8-11周** |

**当前状态**: 生产就绪度65%完成

---

## 后续步骤

1. **立即**（本周）:
   - 对严重问题进行分类
   - 为每个TODO创建Jira/GitHub问题
   - 为阶段1项目分配负责人

2. **短期**（未来2周）:
   - 修复所有严重问题（阶段1）
   - 为修复的代码添加单元测试
   - 更新文档

3. **中期**（接下来4周）:
   - 修复高优先级问题（阶段2）
   - 完成集成测试
   - 性能测试

4. **长期**（第2个月）:
   - 修复中优先级问题（阶段3）
   - 代码审查和清理
   - 生产就绪评估

---

## 附录: 文件位置摘要

### 严重TODO文件（12个文件）
- `/home/eric/payment/backend/services/dispute-service/internal/service/dispute_service.go`（2个严重）
- `/home/eric/payment/backend/services/withdrawal-service/internal/client/bank_transfer_client.go`（3个严重）
- `/home/eric/payment/backend/services/kyc-service/internal/service/kyc_service.go`（2个严重）
- `/home/eric/payment/backend/services/merchant-auth-service/internal/grpc/merchant_auth_server.go`（2个严重）
- `/home/eric/payment/backend/services/settlement-service/internal/service/auto_settlement_task.go`（1个严重）
- `/home/eric/payment/backend/services/payment-gateway/cmd/main.go`（1个严重）
- `/home/eric/payment/backend/services/admin-bff-service/internal/grpc/admin_server.go`（2个严重）
- `/home/eric/payment/backend/services/merchant-quota-service/cmd/main.go`（1个严重）
- `/home/eric/payment/backend/services/reconciliation-service/cmd/main.go`（1个严重）

### 高优先级TODO文件（18个文件）
[见上面详细章节]

### 空/Mock实现的文件
- `/home/eric/payment/backend/services/merchant-quota-service/internal/repository/*.go`（6个文件）
- `/home/eric/payment/backend/services/merchant-policy-service/internal/repository/*.go`（5个文件）
- `/home/eric/payment/backend/services/notification-service/internal/provider/sms_provider.go`
- `/home/eric/payment/backend/services/withdrawal-service/internal/client/bank_transfer_client.go`
