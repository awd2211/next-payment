# 后端TODO - 快速参考指南

**TODO总数**: 57 | **严重**: 12 | **高**: 18 | **中**: 19 | **低**: 8

---

## 严重问题（必须修复 - 生产阻塞）

### 1. Dispute Service（文件: dispute_service.go）
- **行469**: merchantID未初始化 - 从支付记录获取
- **行480**: PaymentNo为空 - 从支付记录获取
- **严重程度**: 严重 | **工作量**: 4h

### 2. Withdrawal Service（文件: bank_transfer_client.go）
- **行334-363**: ABC、BOC、CCB银行API硬编码为mock
- **影响**: 3家主要中国银行的银行转账失败
- **严重程度**: 严重 | **工作量**: 20h实现所有3个银行

### 3. Merchant Auth Service（文件: merchant_auth_server.go）
- **行34**: Login gRPC返回Unimplemented
- **行40**: RefreshToken gRPC返回Unimplemented
- **严重程度**: 严重 | **工作量**: 6h

### 4. Settlement Service（文件: auto_settlement_task.go）
- **行110**: 未集成商户配置服务
- **影响**: 无法强制执行商户特定结算策略
- **严重程度**: 严重 | **工作量**: 8h

### 5. KYC Service（文件: kyc_service.go）
- **行92**: OCR服务未调用
- **行100**: KYC审核员未通知
- **严重程度**: 严重 | **工作量**: 12h

### 6. Payment Gateway（文件: cmd/main.go）
- **行245**: Kafka生产者从未初始化
- **影响**: 事件流完全损坏
- **严重程度**: 严重 | **工作量**: 4h

### 7. Admin BFF Service（文件: admin_server.go）
- **行353**: 商户审核逻辑未实现
- **行430**: 审批流程未实现
- **严重程度**: 严重 | **工作量**: 8h

### 8. Merchant Quota Service（文件: cmd/main.go）
- **行105**: 策略服务客户端未初始化
- **影响**: 配额强制执行不完整
- **严重程度**: 严重 | **工作量**: 4h

---

## 高优先级问题（应该修复 - 主要功能）

| 服务 | 文件 | 行号 | 问题 | 工作量 |
|------|------|------|------|--------|
| Payment Gateway | payment_service.go | 1302 | GeoIP硬编码为"US" | 4h |
| Payment Gateway | webhook_notification_service.go | 177 | 商户密钥硬编码 | 3h |
| Payment Gateway | api_key_repository.go | 146 | CIDR IP白名单不完整 | 2h |
| Settlement | settlement_server.go | 329 | 待结算金额未计算 | 3h |
| Settlement | auto_settlement_task.go | 204 | 退款金额硬编码为0 | 4h |
| Settlement | auto_settlement_task.go | 379 | 通知未发送 | 2h |
| Merchant Auth | api_key_service.go | 102 | API密钥所有权未验证 | 2h |
| Merchant Policy | policy_binding_service.go | 168 | 策略ID验证缺失 | 3h |
| Merchant Policy | tier_service.go | 156 | 无法检查等级使用情况 | 2h |
| Analytics | analytics_server.go | 169 | 跨商户统计不完整 | 4h |
| Analytics | analytics_server.go | 226-269 | 报表生成未实现 | 8h |
| Risk Service | risk_server.go | 58 | 匹配规则列表为空 | 2h |
| Risk Service | risk_handler.go | 328 | 支付反馈未实现 | 4h |
| KYC Service | grpc/kyc_server.go | 180-181 | 邮箱/手机验证未集成 | 3h |
| Order Service | order_handler.go | 805 | 订单统计硬编码 | 2h |
| Config Service | health_checker.go | 144 | 状态更新未实现 | 2h |
| Accounting | account_service.go | 1655 | 汇率未获取 | 3h |

---

## 中优先级问题（应该修复 - 增强功能）

**大部分在Merchant Quota和Merchant Policy服务中 - 仓库不完整**

| 服务 | 文件 | 问题 | 工作量 |
|------|------|------|--------|
| merchant-quota-service | quota_service.go | 策略客户端未集成（3处） | 8h |
| merchant-quota-service | alert_service.go | 通知和策略不完整 | 6h |
| merchant-quota-service | repository/*.go | 所有仓库返回nil/空 | 8h |
| merchant-policy-service | policy_engine_service.go | 阶梯费率规则未解析 | 4h |
| merchant-policy-service | policy_binding_service.go | 自定义策略查询未实现 | 4h |
| merchant-policy-service | repository/*.go | 多个仓库不完整 | 8h |
| admin-bff-service | logging/structured_logger.go | Loki HTTP请求未发送 | 2h |
| merchant-bff-service | logging/structured_logger.go | Loki HTTP请求未发送 | 2h |
| reconciliation-service | cmd/main.go | 自动化未集成 | 8h |
| channel-adapter | channel_service.go | 预授权查找未实现 | 3h |
| pkg/webhook | retry.go | Payload/secret未重新加载 | 2h |
| pkg/email | mailgun.go | REST API和验证不完整 | 4h |

---

## 低优先级问题（可选功能）

- Mock SMS提供商（开发预期）
- 邮件模板占位符（元数据）
- 虚拟数据库健康检查变量（无害）

---

## 推荐修复顺序

### 第1周: 严重（80-100h）
1. Dispute Service（4h）
2. Withdrawal Service（20h）
3. Merchant Auth Service（6h）
4. Settlement Service（8h）
5. Payment Gateway - Kafka（4h）
6. KYC Service（12h）
7. Admin BFF（8h）
8. Merchant Quota - 初始化策略客户端（4h）

### 第2-3周: 高（60-80h）
1. Payment Gateway - GeoIP和webhook密钥（8h）
2. Settlement Service - 退款金额（4h）
3. Analytics Service（12h）
4. Admin BFF - Loki日志（4h）
5. Reconciliation自动化（16h）
6. Risk Service反馈（6h）
7. 其他（10h）

### 第4+周: 中（40-60h）
- Merchant quota/policy仓库（16h）
- Email/webhook改进（6h）
- Channel adapter预授权（3h）
- 代码清理（15h）

---

## 需要关注的文件

### 严重修复文件（前12个）
```
1. /services/dispute-service/internal/service/dispute_service.go
2. /services/withdrawal-service/internal/client/bank_transfer_client.go
3. /services/merchant-auth-service/internal/grpc/merchant_auth_server.go
4. /services/settlement-service/internal/service/auto_settlement_task.go
5. /services/kyc-service/internal/service/kyc_service.go
6. /services/payment-gateway/cmd/main.go
7. /services/admin-bff-service/internal/grpc/admin_server.go
8. /services/merchant-quota-service/cmd/main.go
9. /services/settlement-service/internal/grpc/settlement_server.go
10. /services/payment-gateway/internal/service/payment_service.go
11. /services/payment-gateway/internal/service/webhook_notification_service.go
12. /services/analytics-service/internal/grpc/analytics_server.go
```

---

## 发现的安全问题

- ❌ API密钥所有权未验证（merchant-auth）
- ❌ Webhook密钥硬编码（payment-gateway）
- ❌ CIDR白名单不完整（payment-gateway）
- ❌ 银行API默认为mock（withdrawal-service）
- ❌ 商户审批工作流缺失（admin-bff）

---

## 配置反模式

1. **Mock默认值**: withdrawal-service默认为"mock"银行
2. **硬编码值**: GeoIP = "US"，密钥 = 硬编码
3. **缺失集成**: 策略客户端已注释，通知客户端未调用

---

## 下一步立即行动

1. [ ] 为所有12个严重项目创建GitHub问题
2. [ ] 分配负责人（每个项目1-2人）
3. [ ] 设置阶段1截止日期: 2-3周
4. [ ] 添加CI/CD检查防止不完整提交
5. [ ] 为每个TODO区域创建测试模板
6. [ ] 记录每个gRPC方法Unimplemented的原因
