# 后端TODO - 按文件组织

## 严重问题（共12个）

### dispute-service/internal/service/dispute_service.go
- **行469**: 严重 - merchantID变量未初始化
- **行480**: 严重 - PaymentNo硬编码为""
- **修复**: 查询支付表获取merchant_id和payment_no
- **影响**: 争议未关联到支付/商户
- **工作量**: 4小时

### withdrawal-service/internal/client/bank_transfer_client.go
- **行334**: 严重 - ABC银行API未实现（使用mock）
- **行340**: 严重 - ABC银行查询未实现（使用mock）
- **行345**: 严重 - BOC银行API未实现（使用mock）
- **行351**: 严重 - BOC银行查询未实现（使用mock）
- **行356**: 严重 - CCB银行API未实现（使用mock）
- **行362**: 严重 - CCB银行查询未实现（使用mock）
- **修复**: 实现真实银行API或记录为何使用mock
- **影响**: ABC、BOC、CCB的银行转账失败
- **工作量**: 总计20小时

### withdrawal-service/cmd/main.go
- **行116**: 低 - BankChannel默认为"mock"
- **修复**: 默认为"icbc"或未配置时失败
- **工作量**: 1小时

### merchant-auth-service/internal/grpc/merchant_auth_server.go
- **行30-34**: 严重 - Login返回Unimplemented
- **行38-40**: 严重 - RefreshToken返回Unimplemented
- **修复**: 实现或移除gRPC服务器
- **影响**: gRPC认证完全损坏
- **工作量**: 6小时

### merchant-auth-service/internal/service/api_key_service.go
- **行102**: 高 - API密钥所有权未验证
- **修复**: 检查密钥在使用前是否属于商户
- **影响**: 安全风险 - 密钥可跨商户使用
- **工作量**: 2小时

### settlement-service/internal/service/auto_settlement_task.go
- **行110**: 严重 - 未集成商户配置服务
- **行204**: 高 - 退款金额硬编码为0
- **行379**: 高 - 通知客户端未调用
- **修复**: 初始化策略服务，从accounting获取退款，调用通知器
- **影响**: 结算不完整且无通知
- **工作量**: 总计8小时

### settlement-service/internal/grpc/settlement_server.go
- **行329**: 高 - PendingSettlementAmount硬编码为0
- **修复**: 从结算记录计算
- **工作量**: 3小时

### kyc-service/internal/service/kyc_service.go
- **行92**: 严重 - OCR服务未调用
- **行100**: 严重 - KYC审核员未通知
- **修复**: 调用OCR服务，调用通知服务
- **影响**: 文档验证不完整
- **工作量**: 12小时

### kyc-service/internal/grpc/kyc_server.go
- **行180**: 高 - EmailVerified总是false
- **行181**: 高 - PhoneVerified总是false
- **修复**: 与商户服务集成以进行验证
- **工作量**: 3小时

### payment-gateway/cmd/main.go
- **行245**: 严重 - Kafka生产者从未初始化
- **修复**: 实现KafkaProducer初始化
- **影响**: 事件流完全损坏
- **工作量**: 4小时

### payment-gateway/internal/service/payment_service.go
- **行1302**: 高 - GeoIP硬编码为"US"
- **行1383**: 高 - 国家检测仅注释
- **修复**: 调用GeoIP服务或使用IP头
- **影响**: 风控评分总是使用US地理位置
- **工作量**: 4小时

### payment-gateway/internal/service/webhook_notification_service.go
- **行177**: 高 - 商户webhook密钥硬编码
- **修复**: 运行时从数据库/缓存获取
- **影响**: Webhook签名总是使用硬编码值
- **工作量**: 3小时

### payment-gateway/internal/repository/api_key_repository.go
- **行146**: 高 - CIDR IP白名单未完全实现
- **修复**: 使用net.IPNet.Contains()实现正确的CIDR支持
- **工作量**: 2小时

### admin-bff-service/internal/grpc/admin_server.go
- **行353**: 严重 - 商户审核逻辑未实现
- **行360**: 高 - 商户审核列表查询未实现
- **行430**: 严重 - 审批流程未实现
- **行436**: 高 - 审批处理未实现
- **行442**: 高 - 审批列表查询未实现
- **修复**: 实现或移除gRPC方法
- **影响**: 无法通过gRPC批准商户
- **工作量**: 8小时

### admin-bff-service/internal/logging/structured_logger.go
- **行262**: 中 - Loki HTTP请求未发送
- **修复**: 实际发送日志到Loki端点
- **影响**: 日志未持久化到日志聚合
- **工作量**: 2小时

### merchant-bff-service/internal/logging/structured_logger.go
- **行262**: 中 - Loki HTTP请求未发送
- **修复**: 实际发送日志到Loki端点
- **工作量**: 2小时

### merchant-quota-service/cmd/main.go
- **行105**: 严重 - 商户策略服务客户端未初始化
- **修复**: 取消注释并初始化policyClient
- **影响**: 策略服务集成不完整
- **工作量**: 4小时

### merchant-quota-service/internal/service/quota_service.go
- **行47**: 中 - PolicyClient未添加
- **行122**: 中 - 策略服务调用未执行
- **行174**: 中 - 策略验证缺失
- **修复**: 使用初始化的策略服务客户端
- **工作量**: 8小时

### merchant-quota-service/internal/service/alert_service.go
- **行39**: 中 - NotificationClient未添加
- **行84**: 中 - 策略服务调用缺失
- **行113**: 中 - 通知未发送
- **行146**: 中 - 策略服务调用缺失
- **修复**: 添加客户端并实现调用
- **工作量**: 6小时

### merchant-quota-service/internal/repository/
- **quota_repository.go**: 中 - 方法返回nil
- **usage_log_repository.go**: 中 - 方法返回nil
- **alert_repository.go**: 中 - 方法返回nil
- **修复**: 实现实际的GORM持久化
- **工作量**: 8小时

### merchant-policy-service/cmd/main.go
- **行110**: 中 - ChannelPolicyRepository未使用
- **修复**: 使用或移除初始化
- **工作量**: 1小时

### merchant-policy-service/internal/service/policy_binding_service.go
- **行168**: 中 - 自定义策略ID验证缺失
- **行198**: 中 - 自定义策略查询未实现
- **修复**: 添加验证和查询
- **工作量**: 4小时

### merchant-policy-service/internal/service/policy_engine_service.go
- **行162**: 中 - 阶梯费率规则未解析
- **修复**: 解析JSON TieredRules用于费率计算
- **影响**: 仅支持固定费率
- **工作量**: 4小时

### merchant-policy-service/internal/service/tier_service.go
- **行156**: 中 - 无法检查商户等级使用情况
- **修复**: 删除前查询使用等级的商户
- **工作量**: 2小时

### merchant-policy-service/internal/repository/
- **fee_policy_repository.go**: 中 - 所有方法不完整
- **limit_policy_repository.go**: 中 - 所有方法不完整
- **channel_policy_repository.go**: 中 - 所有方法不完整
- **policy_binding_repository.go**: 中 - 方法不完整
- **tier_repository.go**: 中 - 方法不完整
- **修复**: 为所有实现GORM持久化
- **工作量**: 8小时

### analytics-service/internal/grpc/analytics_server.go
- **行169**: 高 - 跨商户统计查询未实现
- **行226**: 高 - 系统健康检查未实现
- **行247**: 高 - 报表生成未实现
- **行269**: 高 - 报表存储/查询未实现
- **修复**: 实现仓库层查询
- **工作量**: 12小时

### risk-service/internal/grpc/risk_server.go
- **行58**: 中 - MatchedRules列表为空
- **修复**: 填充匹配的规则名称
- **工作量**: 2小时

### risk-service/internal/handler/risk_handler.go
- **行328**: 高 - 支付反馈未实现
- **修复**: 调用反馈机制用于模型训练
- **工作量**: 4小时

### order-service/internal/handler/order_handler.go
- **行805**: 高 - 订单统计硬编码
- **修复**: 查询数据库获取真实统计
- **工作量**: 2小时

### config-service/internal/service/health_checker.go
- **行144**: 高 - 状态更新逻辑未实现
- **修复**: 实现状态管理
- **工作量**: 2小时

### accounting-service/internal/service/account_service.go
- **行1655**: 高 - 汇率未从channel-adapter获取
- **修复**: 调用channel-adapter API获取汇率
- **影响**: 多币种转换使用默认值
- **工作量**: 3小时

### channel-adapter/internal/service/channel_service.go
- **行728**: 中 - 预授权记录查找未实现
- **修复**: 查询预授权记录以确定渠道
- **工作量**: 3小时

### notification-service/internal/provider/sms_provider.go
- **行88-97**: 低 - Mock SMS提供商返回"mock" ID
- **修复**: 开发可接受
- **工作量**: 0小时（预期）

### notification-service/cmd/main.go
- **行166**: 低 - Mock SMS提供商已注册
- **修复**: 开发可接受
- **工作量**: 0小时（预期）

### reconciliation-service/cmd/main.go
- **行101**: 严重 - 自动化功能未集成
- **影响**: 仅支持手动对账
- **修复**: 集成调度器、检测器、通知器
- **工作量**: 8小时

### pkg/webhook/retry.go
- **行402**: 中 - Payload/secret未从数据库重新加载
- **修复**: 重试时获取新凭证
- **工作量**: 2小时

### pkg/email/mailgun.go
- **行221**: 中 - REST API统计未实现
- **行230**: 中 - 邮件验证API未实现
- **修复**: 实现Mailgun API调用
- **工作量**: 4小时

---

## 汇总表

| 文件 | 严重 | 高 | 中 | 低 | 总计 |
|------|------|----|----|----|----|
| dispute_service.go | 2 | 0 | 0 | 0 | 2 |
| bank_transfer_client.go | 6 | 0 | 0 | 0 | 6 |
| merchant_auth_server.go | 2 | 0 | 0 | 0 | 2 |
| auto_settlement_task.go | 1 | 2 | 0 | 0 | 3 |
| settlement_server.go | 0 | 1 | 0 | 0 | 1 |
| kyc_service.go | 2 | 0 | 0 | 0 | 2 |
| kyc_server.go | 0 | 2 | 0 | 0 | 2 |
| payment-gateway（各种） | 1 | 4 | 0 | 0 | 5 |
| admin_server.go | 2 | 3 | 0 | 0 | 5 |
| admin-bff日志 | 0 | 0 | 1 | 0 | 1 |
| merchant-bff日志 | 0 | 0 | 1 | 0 | 1 |
| merchant-quota（各种） | 1 | 0 | 6 | 0 | 7 |
| merchant-policy（各种） | 0 | 0 | 6 | 0 | 6 |
| analytics_server.go | 0 | 4 | 0 | 0 | 4 |
| risk（各种） | 0 | 2 | 1 | 0 | 3 |
| order_handler.go | 0 | 1 | 0 | 0 | 1 |
| config health_checker.go | 0 | 1 | 0 | 0 | 1 |
| account_service.go | 0 | 1 | 0 | 0 | 1 |
| channel_service.go | 0 | 0 | 1 | 0 | 1 |
| sms_provider.go | 0 | 0 | 0 | 1 | 1 |
| reconciliation main.go | 1 | 0 | 0 | 0 | 1 |
| pkg/webhook/retry.go | 0 | 0 | 1 | 0 | 1 |
| pkg/email/mailgun.go | 0 | 0 | 2 | 0 | 2 |
| **总计** | **12** | **18** | **19** | **8** | **57** |

---

## 需要立即关注的关键文件

1. **dispute_service.go** - 关联争议到支付（4h）
2. **bank_transfer_client.go** - 实现3个中国银行API（20h）
3. **merchant_auth_server.go** - 实现gRPC认证（6h）
4. **auto_settlement_task.go** - 完成结算流程（8h）
5. **cmd/main.go**（payment-gateway） - 初始化Kafka（4h）
6. **kyc_service.go** - 实现OCR和通知（12h）
7. **admin_server.go** - 实现商户审批工作流（8h）
8. **cmd/main.go**（merchant-quota） - 初始化策略客户端（4h）

**严重总计: 80-100小时**
